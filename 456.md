# Error 1101 問題總結與解決方案

## 問題描述
網站多個頁面出現 Error 1101 (Worker threw exception)，導致 Cloudflare Worker 崩潰。

## 根本原因
1. **Token 解析問題**：多個 Functions 文件在使用 `atob(parts[1])` 時沒有檢查 `parts[1]` 是否存在
2. **N+1 查詢優化導致的問題**：`courses.ts` 的 JOIN 查詢可能有問題
3. **SQL 注入漏洞**：`forum/topics.ts` 使用 `sql.unsafe()` 導致 SQL 語法錯誤

## 已修改的文件（可能需要回滾）
- functions/utils/error-handler.ts ✅ (這個修改是正確的)
- functions/api/v1/courses.ts ✅ (已回滾)
- functions/api/v1/forum/topics.ts ⚠️ (已回滾但可能還有問題)
- functions/api/v1/admin/experiences.ts
- functions/api/v1/experiences/[experienceId]/comments.ts
- functions/api/v1/experiences/[experienceId]/like.ts
- functions/api/v1/forum/topics/[topicId].ts
- functions/api/v1/forum/topics/[topicId]/replies.ts
- functions/api/v1/groups/[groupId].ts
- functions/api/v1/groups/[groupId]/join.ts
- functions/api/v1/instructors/experiences.ts
- functions/api/v1/ttqs/plans/[planId].ts
- src/services/api.ts ✅ (前端修改是正確的)
- src/stores/auth.ts ✅ (前端修改是正確的)
- src/services/auth-service-enhanced.ts ✅ (前端修改是正確的)

## 建議的解決方案

### 選項 1：完全回滾（最安全）
回滾到 2025-11-16 的最後一個正常版本 (f7bf113)，然後重新開始：

```bash
git reset --hard f7bf113
git push --force
```

### 選項 2：保留正確的修改，只回滾有問題的
1. 保留前端的修改（api.ts, auth.ts, auth-service-enhanced.ts）
2. 保留 functions/utils/error-handler.ts 的修改
3. 回滾所有其他 Functions 文件到之前的版本

### 選項 3：逐個修復（最耗時）
逐個測試每個 API 端點，找出真正有問題的地方並修復。

## 測試命令
```bash
# 測試各個 API 端點
curl -s 'https://ttqs.24cc.cc/api/v1/courses?page=1&limit=3'
curl -s 'https://ttqs.24cc.cc/api/v1/forum/topics?page=1&limit=10'
curl -s 'https://ttqs.24cc.cc/api/v1/groups?page=1&limit=10'
curl -s 'https://ttqs.24cc.cc/api/v1/jobs?page=1&limit=3'
```

## 下一步行動
建議採用**選項 1**，完全回滾到昨天的版本，然後：
1. 先確認網站能正常運作
2. 只修改真正需要修改的地方（前端的 token 驗證）
3. 後端的 token 解析問題可以通過前端驗證來避免

## 教訓
1. 不要一次修改太多文件
2. 每次修改後都要測試
3. 使用 feature branch 而不是直接在 main 上修改
4. 保持修改的最小化原則
