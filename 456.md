# ä»£ç¢¼å„ªåŒ–å»ºè­°å ±å‘Š

## ğŸ” ä»£ç¢¼æƒæåˆ†æå ±å‘Š

### ğŸ“Š é …ç›®æ¦‚æ³
- **é …ç›®åç¨±**: è—¥åŠ©Nextå­¸é™¢ (pharmacy-assistant-academy)
- **é …ç›®é¡å‹**: Vue 3 + TypeScript å…¨æ£§æ‡‰ç”¨ (è—¥å±€åŠ©ç†è½‰è·æ•™è‚²å¹³å°)
- **éƒ¨ç½²ç’°å¢ƒ**: Cloudflare Pages + Workers
- **æ•¸æ“šåº«**: Neon PostgreSQL (Serverless)
- **ç¸½æ–‡ä»¶æ•¸**: 223 å€‹ (.ts, .vue)
- **ç¸½ä»£ç¢¼è¡Œæ•¸**: ~12,000+ è¡Œ

### ğŸ“ é …ç›®çµæ§‹çµ±è¨ˆ

| é¡åˆ¥ | æ•¸é‡ | ä»£ç¢¼è¡Œæ•¸ | ç›®éŒ„ |
|------|------|----------|------|
| **Cloudflare API è·¯ç”±** | 35 å€‹æ–‡ä»¶ | 2,154 è¡Œ | `functions/api/v1/` |
| **å‰ç«¯ API å±¤** | 82 å€‹æ–‡ä»¶ | 7,184 è¡Œ | `src/api/` |
| **æœå‹™å±¤** | 14 å€‹æ–‡ä»¶ | 2,787 è¡Œ | `src/services/` |
| **çµ„ä»¶** | 34 å€‹æ–‡ä»¶ | N/A | `src/components/` |
| **è¦–åœ–** | 51 å€‹æ–‡ä»¶ | N/A | `src/views/` |
| **æ•¸æ“šåº«å·¥å…·** | 4 å€‹æ–‡ä»¶ | ~300 è¡Œ | `src/config/`, `src/utils/` |
| **ä¸­é–“ä»¶** | 2 å€‹æ–‡ä»¶ | ~400 è¡Œ | `functions/`, `src/middleware/` |
| **éŒ¯èª¤è™•ç†** | 3 å€‹æ–‡ä»¶ | ~540 è¡Œ | `functions/utils/`, `src/api/`, `src/services/` |
| **Repository é¡** | 23 å€‹é¡ | N/A | ç¹¼æ‰¿ BaseRepository |
| **è·¯ç”±è¨»å†Š** | 241+ å€‹ | N/A | router.get/post/put/delete |

---

## ğŸ¯ å„ªåŒ–å»ºè­°

### 1ï¸âƒ£ **æ¶æ§‹å„ªåŒ– (é«˜å„ªå…ˆç´š)** ğŸ”´

#### å•é¡Œ 1: é›™é‡ API ç³»çµ±

**ç¾ç‹€**: 
å­˜åœ¨å…©å¥—ä¸¦è¡Œçš„ API ç³»çµ±:
- `functions/api/v1/` - Cloudflare Functions (35 å€‹æ–‡ä»¶, 2,154 è¡Œ)
- `src/api/` - å‰ç«¯ API è·¯ç”± (82 å€‹æ–‡ä»¶, 7,184 è¡Œ)

**å½±éŸ¿**:
- è·¯ç”±å®šç¾©é‡è¤‡
- ç¶­è­·æˆæœ¬é«˜ (éœ€è¦åŒæ­¥æ›´æ–°å…©å€‹åœ°æ–¹)
- å®¹æ˜“é€ æˆä¸ä¸€è‡´
- ä»£ç¢¼å†—é¤˜åº¦é«˜é” 40%

**å»ºè­°æ–¹æ¡ˆ**:
```
çµ±ä¸€ç‚ºå–®ä¸€ API å…¥å£é»

æ¨è–¦æ–¹æ¡ˆ: ä½¿ç”¨ Cloudflare Functions ä½œç‚ºä¸»è¦å¾Œç«¯ API

æ­¥é©Ÿ:
1. ä¿ç•™ functions/api/v1/ ä½œç‚ºå”¯ä¸€çš„ API å±¤
2. ç§»é™¤ src/api/ ä¸­çš„è·¯ç”±å®šç¾©å’Œæ¥­å‹™é‚è¼¯
3. ä¿ç•™ src/services/ ä½œç‚ºå‰ç«¯ API èª¿ç”¨å±¤
4. å°‡ src/api/ ä¸­çš„ Repository é¡é·ç§»åˆ°å¾Œç«¯æˆ–æœå‹™å±¤
5. æ¸…ç†å†—é¤˜ä»£ç¢¼,é è¨ˆå¯æ¸›å°‘ç´„ 40% çš„ä»£ç¢¼é‡
```

**é·ç§»ç¤ºä¾‹**:

```typescript
// âŒ ç•¶å‰: src/api/courses/index.ts (é‡è¤‡çš„è·¯ç”±å®šç¾©)
router.get('/api/v1/courses', async (req: ApiRequest): Promise<ApiResponse> => {
  // æ¥­å‹™é‚è¼¯
})

// âœ… æ”¹ç‚º: åªåœ¨ functions/api/v1/courses/index.ts å®šç¾©
export const onRequestGet = withErrorHandler(async (context) => {
  // æ¥­å‹™é‚è¼¯
}, 'Get Courses')

// âœ… å‰ç«¯: src/services/course-service.ts (åªè² è²¬èª¿ç”¨)
export const courseService = {
  async getCourses(filters?: CourseFilters): Promise<Course[]> {
    return await apiService.get<Course[]>('/courses', { params: filters })
  }
}
```

---

#### å•é¡Œ 2: ä¸‰å¥—æ•¸æ“šåº«æŠ½è±¡å±¤

**ç¾ç‹€**:
å­˜åœ¨ä¸‰å€‹ä¸åŒçš„æ•¸æ“šåº«æŠ½è±¡å±¤,è·è²¬é‡ç–Š:
- `src/config/database.ts` - pg Pool é…ç½®
- `src/utils/database.ts` - DatabaseUtils é¡
- `src/utils/neon-database.ts` - NeonDatabaseManager
- `src/utils/cloudflare-database.ts` - Cloudflare é©é…å™¨ (2,685 è¡Œ)

**å•é¡Œ**:
- è·è²¬é‡ç–Š,ä¸åŒéƒ¨åˆ†ä½¿ç”¨ä¸åŒçš„æŠ½è±¡å±¤
- äº‹å‹™è™•ç†ä¸ä¸€è‡´ (Neon çš„äº‹å‹™æ²’æœ‰çœŸæ­£å¯¦ç¾)
- ç’°å¢ƒè®Šé‡è¨ªå•ä¸ä¸€è‡´ (`process.env` vs `globalThis.env`)

**å»ºè­°æ–¹æ¡ˆ**:

```typescript
// âœ… çµ±ä¸€æ•¸æ“šåº«æŠ½è±¡å±¤è¨­è¨ˆ

// 1. å®šç¾©çµ±ä¸€æ¥å£ (src/database/adapter.interface.ts)
export interface DatabaseAdapter {
  query<T>(sql: string, params?: any[]): Promise<T[]>
  queryOne<T>(sql: string, params?: any[]): Promise<T | null>
  transaction<T>(callback: (db: DatabaseAdapter) => Promise<T>): Promise<T>
  tableExists(tableName: string): Promise<boolean>
}

// 2. å¯¦ç¾ Neon é©é…å™¨ (src/database/adapters/neon.adapter.ts)
export class NeonAdapter implements DatabaseAdapter {
  private sql: ReturnType<typeof neon>
  
  constructor(connectionString: string) {
    this.sql = neon(connectionString)
  }
  
  async query<T>(sql: string, params: any[] = []): Promise<T[]> {
    const result = await this.sql(sql, params)
    return Array.isArray(result) ? result : result.rows || []
  }
  
  async queryOne<T>(sql: string, params: any[] = []): Promise<T | null> {
    const results = await this.query<T>(sql, params)
    return results[0] || null
  }
  
  async transaction<T>(callback: (db: DatabaseAdapter) => Promise<T>): Promise<T> {
    await this.query('BEGIN')
    try {
      const result = await callback(this)
      await this.query('COMMIT')
      return result
    } catch (error) {
      await this.query('ROLLBACK')
      throw error
    }
  }
  
  async tableExists(tableName: string): Promise<boolean> {
    const result = await this.queryOne<{ exists: boolean }>(
      `SELECT EXISTS (
        SELECT FROM information_schema.tables 
        WHERE table_name = $1
      )`,
      [tableName]
    )
    return result?.exists || false
  }
}

// 3. å¯¦ç¾ PostgreSQL é©é…å™¨ (src/database/adapters/postgres.adapter.ts)
export class PostgresAdapter implements DatabaseAdapter {
  private pool: Pool
  
  constructor(config: PoolConfig) {
    this.pool = new Pool(config)
  }
  
  async query<T>(sql: string, params: any[] = []): Promise<T[]> {
    const client = await this.pool.connect()
    try {
      const result = await client.query(sql, params)
      return result.rows
    } finally {
      client.release()
    }
  }
  
  // ... å¯¦ç¾å…¶ä»–æ–¹æ³•
}

// 4. å·¥å» å‡½æ•¸ (src/database/index.ts)
export function createDatabase(): DatabaseAdapter {
  const databaseUrl = process.env.DATABASE_URL || (globalThis as any)?.env?.DATABASE_URL
  
  if (!databaseUrl) {
    throw new Error('DATABASE_URL not configured')
  }
  
  // æ ¹æ“šç’°å¢ƒé¸æ“‡é©é…å™¨
  const isCloudflareWorker = typeof (globalThis as any)?.caches !== 'undefined'
  
  if (isCloudflareWorker) {
    return new NeonAdapter(databaseUrl)
  } else {
    return new PostgresAdapter({ connectionString: databaseUrl })
  }
}

// 5. å°å‡ºå–®ä¸€å¯¦ä¾‹
export const db = createDatabase()
```

**ä½¿ç”¨ç¤ºä¾‹**:

```typescript
// âœ… çµ±ä¸€çš„ä½¿ç”¨æ–¹å¼
import { db } from '@/database'

// ç°¡å–®æŸ¥è©¢
const users = await db.query<User>('SELECT * FROM users WHERE is_active = $1', [true])

// å–®æ¢æŸ¥è©¢
const user = await db.queryOne<User>('SELECT * FROM users WHERE id = $1', [userId])

// äº‹å‹™
await db.transaction(async (trx) => {
  await trx.query('INSERT INTO orders (...) VALUES (...)', [...])
  await trx.query('UPDATE inventory SET stock = stock - 1 WHERE id = $1', [itemId])
})
```

---

#### å•é¡Œ 3: æ··åˆå‘½åç´„å®š

**ç¾ç‹€**: 
åŒæ™‚å­˜åœ¨é§å³°å’Œä¸‹åŠƒç·šå‘½å,å°è‡´æ··äº‚

```typescript
// âŒ ç•¶å‰ä»£ç¢¼
req.user = {
  userType: 'admin',      // é§å³°
  user_type: 'admin',     // ä¸‹åŠƒç·š
  firstName: 'John',
  first_name: 'John'
}
```

**å»ºè­°æ–¹æ¡ˆ**:

```typescript
// âœ… çµ±ä¸€ä½¿ç”¨é§å³°å‘½å (camelCase)

// 1. å®šç¾©æ¨™æº–çš„ç”¨æˆ¶æ¥å£
interface User {
  id: number
  email: string
  userType: 'admin' | 'instructor' | 'employer' | 'job_seeker'
  firstName: string
  lastName: string
  createdAt: Date
  updatedAt: Date
}

// 2. æ•¸æ“šåº«æŸ¥è©¢å¾Œè½‰æ›
function mapDbUser(dbRow: any): User {
  return {
    id: dbRow.id,
    email: dbRow.email,
    userType: dbRow.user_type,      // è½‰æ›
    firstName: dbRow.first_name,    // è½‰æ›
    lastName: dbRow.last_name,      // è½‰æ›
    createdAt: new Date(dbRow.created_at),
    updatedAt: new Date(dbRow.updated_at)
  }
}

// 3. å‰µå»ºé€šç”¨çš„æ˜ å°„å·¥å…·
function toCamelCase(obj: any): any {
  if (Array.isArray(obj)) {
    return obj.map(toCamelCase)
  }
  
  if (obj !== null && obj.constructor === Object) {
    return Object.keys(obj).reduce((result, key) => {
      const camelKey = key.replace(/_([a-z])/g, (_, letter) => letter.toUpperCase())
      result[camelKey] = toCamelCase(obj[key])
      return result
    }, {} as any)
  }
  
  return obj
}

// 4. åœ¨æ•¸æ“šåº«é©é…å™¨ä¸­è‡ªå‹•è½‰æ›
export class DatabaseAdapter {
  async query<T>(sql: string, params?: any[]): Promise<T[]> {
    const result = await this.rawQuery(sql, params)
    return toCamelCase(result.rows)
  }
}
```

---

### 2ï¸âƒ£ **å®‰å…¨å•é¡Œä¿®å¾© (é«˜å„ªå…ˆç´š)** ğŸ”´

#### ğŸš¨ å•é¡Œ 1: ç¡¬ç·¨ç¢¼çš„ JWT Secret

**ä½ç½®**: `src/api/auth-middleware.ts:14-18`

```typescript
// âŒ ç•¶å‰ä»£ç¢¼ - åš´é‡å®‰å…¨éš±æ‚£
const verifyToken = (token: string) => {
  // å˜—è©¦å¤šå€‹å¯èƒ½çš„ JWT secret
  const secrets = [
    process.env.JWT_SECRET,
    'test-secret',
    '3939889'  // âŒ ç¡¬ç·¨ç¢¼çš„ç”Ÿç”¢ç’°å¢ƒ secret
  ]
  
  for (const secret of secrets) {
    try {
      const result = jwt.verify(token, secret as string) as any
      console.log('[verifyToken] Success with secret:', secret)  // âŒ æ´©éœ²ä½¿ç”¨çš„ secret
      return result
    } catch (error) {
      continue
    }
  }
  
  throw new AuthenticationError('èªè­‰ä»¤ç‰Œç„¡æ•ˆæˆ–å·²éæœŸ')
}
```

**å®‰å…¨é¢¨éšª**:
- ç¡¬ç·¨ç¢¼çš„ secret å¯è¢«ä»»ä½•äººæŸ¥çœ‹æºç¢¼ç²å–
- æ”»æ“Šè€…å¯ä»¥å½é€ ä»»æ„ JWT token
- å³ä½¿æ›´æ”¹ç’°å¢ƒè®Šé‡,ç¡¬ç·¨ç¢¼çš„ secret ä»ç„¶æœ‰æ•ˆ

**ä¿®å¾©æ–¹æ¡ˆ**:

```typescript
// âœ… æ­£ç¢ºåšæ³•
const verifyToken = (token: string): JWTPayload => {
  const secret = process.env.JWT_SECRET || (globalThis as any)?.env?.JWT_SECRET
  
  // ç”Ÿç”¢ç’°å¢ƒå¿…é ˆé…ç½® secret
  if (!secret) {
    throw new AuthenticationError('JWT secret not configured')
  }
  
  try {
    const payload = jwt.verify(token, secret) as JWTPayload
    
    // é©—è­‰å¿…è¦å­—æ®µ
    if (!payload.userId && !payload.id) {
      throw new AuthenticationError('Invalid token: missing user ID')
    }
    
    return payload
  } catch (error) {
    if (error instanceof jwt.TokenExpiredError) {
      throw new AuthenticationError('èªè­‰ä»¤ç‰Œå·²éæœŸ')
    }
    throw new AuthenticationError('èªè­‰ä»¤ç‰Œç„¡æ•ˆ')
  }
}

// âœ… æ·»åŠ  token payload é¡å‹å®šç¾©
interface JWTPayload {
  userId: number
  email: string
  userType: string
  iat: number
  exp: number
}
```

**ç’°å¢ƒè®Šé‡é…ç½®**:

```bash
# .env.example
JWT_SECRET=your-very-secure-random-string-at-least-32-characters
JWT_EXPIRES_IN=1h

# ç”Ÿæˆå¼·éš¨æ©Ÿ secret çš„å‘½ä»¤
# Node.js: 
node -e "console.log(require('crypto').randomBytes(64).toString('hex'))"

# OpenSSL:
openssl rand -hex 64
```

---

#### ğŸš¨ å•é¡Œ 2: CORS è¨­ç½®éæ–¼å¯¬é¬†

**ä½ç½®**: `functions/_middleware.ts:13`

```typescript
// âŒ ç•¶å‰ä»£ç¢¼ - å…è¨±ä»»æ„ä¾†æº
export async function onRequest(context: any) {
  const response = await context.next()
  
  // CORS é ­
  if (context.request.url.includes('/api/')) {
    response.headers.set('Access-Control-Allow-Origin', '*')  // âŒ å…è¨±æ‰€æœ‰ä¾†æº
    response.headers.set('Access-Control-Allow-Methods', 'GET, POST, PUT, DELETE, OPTIONS')
    response.headers.set('Access-Control-Allow-Headers', 'Content-Type, Authorization, X-Request-ID')
  }
  
  return response
}
```

**å®‰å…¨é¢¨éšª**:
- ä»»ä½•ç¶²ç«™éƒ½å¯ä»¥èª¿ç”¨ä½ çš„ API
- å®¹æ˜“å—åˆ° CSRF æ”»æ“Š
- æ•æ„Ÿæ•¸æ“šå¯èƒ½è¢«æƒ¡æ„ç¶²ç«™ç²å–

**ä¿®å¾©æ–¹æ¡ˆ**:

```typescript
// âœ… ä½¿ç”¨ä¾†æºç™½åå–®
const ALLOWED_ORIGINS = [
  'https://pharmacy-academy.com',
  'https://www.pharmacy-academy.com',
  'https://preview.pharmacy-academy.com',
  // é–‹ç™¼ç’°å¢ƒ
  ...(process.env.NODE_ENV === 'development' 
    ? ['http://localhost:5173', 'http://127.0.0.1:5173'] 
    : [])
]

export async function onRequest(context: any) {
  const request = context.request
  const response = await context.next()
  
  // å®‰å…¨é ­
  response.headers.set('X-Frame-Options', 'DENY')
  response.headers.set('X-Content-Type-Options', 'nosniff')
  response.headers.set('Referrer-Policy', 'strict-origin-when-cross-origin')
  response.headers.set('Permissions-Policy', 'camera=(), microphone=(), geolocation=()')
  
  // CORS é ­ - åƒ… API è·¯ç”±
  if (request.url.includes('/api/')) {
    const origin = request.headers.get('Origin')
    
    // æª¢æŸ¥ä¾†æºæ˜¯å¦åœ¨ç™½åå–®ä¸­
    if (origin && ALLOWED_ORIGINS.includes(origin)) {
      response.headers.set('Access-Control-Allow-Origin', origin)
      response.headers.set('Access-Control-Allow-Credentials', 'true')
    } else if (origin) {
      // è¨˜éŒ„æœªæˆæ¬Šçš„ä¾†æº
      console.warn(`Blocked CORS request from unauthorized origin: ${origin}`)
    }
    
    response.headers.set('Access-Control-Allow-Methods', 'GET, POST, PUT, DELETE, OPTIONS')
    response.headers.set(
      'Access-Control-Allow-Headers', 
      'Content-Type, Authorization, X-Request-ID'
    )
    response.headers.set('Access-Control-Max-Age', '86400') // 24 å°æ™‚
  }
  
  return response
}
```

**Cloudflare Workers ç’°å¢ƒè®Šé‡é…ç½®**:

```toml
# wrangler.toml
[vars]
ALLOWED_ORIGINS = "https://pharmacy-academy.com,https://preview.pharmacy-academy.com"

# æˆ–åœ¨ Cloudflare Dashboard ä¸­é…ç½®ç’°å¢ƒè®Šé‡
```

---

#### ğŸš¨ å•é¡Œ 3: SQL æ³¨å…¥é¢¨éšª

**ä½ç½®**: `src/utils/database.ts:75`

```typescript
// âŒ ä¸å®‰å…¨ - ç›´æ¥æ‹¼æ¥è¡¨å
async getTableRowCount(tableName: string): Promise<number> {
  const result = await this.queryOne(`SELECT COUNT(*) as count FROM ${tableName}`)
  return result?.count || 0
}
```

**å®‰å…¨é¢¨éšª**:
- æ”»æ“Šè€…å¯ä»¥æ³¨å…¥æƒ¡æ„ SQL: `users; DROP TABLE users; --`
- å¯ä»¥æŸ¥è©¢ä»»æ„è¡¨çš„æ•¸æ“š
- å¯èƒ½å°è‡´æ•¸æ“šæ´©éœ²æˆ–åˆªé™¤

**ä¿®å¾©æ–¹æ¡ˆ**:

```typescript
// âœ… æ–¹æ¡ˆ 1: ä½¿ç”¨è¡¨åç™½åå–®
async getTableRowCount(tableName: string): Promise<number> {
  // å®šç¾©å…è¨±çš„è¡¨å
  const ALLOWED_TABLES = [
    'users',
    'courses',
    'jobs',
    'enrollments',
    'applications',
    'instructors',
    'experiences',
    'forum_topics',
    'groups'
  ]
  
  // é©—è­‰è¡¨å
  if (!ALLOWED_TABLES.includes(tableName)) {
    throw new Error(`Invalid table name: ${tableName}`)
  }
  
  // ä½¿ç”¨åƒæ•¸åŒ–æŸ¥è©¢ (é›–ç„¶ pg ä¸æ”¯æŒè¡¨ååƒæ•¸åŒ–,ä½†å·²é€šéç™½åå–®é©—è­‰)
  const result = await this.queryOne<{ count: number }>(
    `SELECT COUNT(*) as count FROM ${tableName}`
  )
  
  return result?.count || 0
}

// âœ… æ–¹æ¡ˆ 2: ä½¿ç”¨æ¨™è­˜ç¬¦è½‰ç¾© (PostgreSQL)
import { escapeIdentifier } from 'pg'

async getTableRowCount(tableName: string): Promise<number> {
  // é©—è­‰è¡¨åæ ¼å¼ (åªå…è¨±å­—æ¯ã€æ•¸å­—å’Œä¸‹åŠƒç·š)
  if (!/^[a-z_][a-z0-9_]*$/i.test(tableName)) {
    throw new Error(`Invalid table name format: ${tableName}`)
  }
  
  // é©—è­‰è¡¨æ˜¯å¦å­˜åœ¨
  const tableExists = await this.queryOne<{ exists: boolean }>(
    `SELECT EXISTS (
      SELECT FROM information_schema.tables 
      WHERE table_schema = 'public' 
      AND table_name = $1
    )`,
    [tableName]
  )
  
  if (!tableExists?.exists) {
    throw new Error(`Table does not exist: ${tableName}`)
  }
  
  // ä½¿ç”¨è½‰ç¾©çš„æ¨™è­˜ç¬¦
  const escapedTable = escapeIdentifier(tableName)
  const result = await this.queryOne<{ count: number }>(
    `SELECT COUNT(*) as count FROM ${escapedTable}`
  )
  
  return result?.count || 0
}
```

**å…¶ä»– SQL æ³¨å…¥é˜²è­·å»ºè­°**:

```typescript
// âœ… å§‹çµ‚ä½¿ç”¨åƒæ•¸åŒ–æŸ¥è©¢
// âŒ éŒ¯èª¤
const users = await db.query(`SELECT * FROM users WHERE email = '${email}'`)

// âœ… æ­£ç¢º
const users = await db.query('SELECT * FROM users WHERE email = $1', [email])

// âœ… å°æ–¼å‹•æ…‹ WHERE æ¢ä»¶,æ§‹å»ºåƒæ•¸åŒ–æŸ¥è©¢
function buildWhereClause(filters: Record<string, any>) {
  const conditions: string[] = []
  const params: any[] = []
  let paramIndex = 1
  
  Object.entries(filters).forEach(([key, value]) => {
    if (value !== undefined && value !== null) {
      conditions.push(`${key} = $${paramIndex}`)
      params.push(value)
      paramIndex++
    }
  })
  
  return {
    whereClause: conditions.length > 0 ? `WHERE ${conditions.join(' AND ')}` : '',
    params
  }
}

// ä½¿ç”¨
const { whereClause, params } = buildWhereClause({ status: 'active', user_type: 'instructor' })
const users = await db.query(`SELECT * FROM users ${whereClause}`, params)
```

---

### 3ï¸âƒ£ **ä»£ç¢¼è³ªé‡å„ªåŒ– (ä¸­å„ªå…ˆç´š)** âš ï¸

#### å•é¡Œ 1: éå¤šçš„ console.log

**çµ±è¨ˆ**: 
åœ¨ `functions/` å’Œ `src/` ç›®éŒ„ç™¼ç¾ 120+ å€‹ console èªå¥,åœ¨ç”Ÿç”¢ç’°å¢ƒä¹ŸæœƒåŸ·è¡Œ

**ç¤ºä¾‹ä½ç½®**:
- `src/router/index.ts:522` - è·¯ç”±å®ˆè¡›æ—¥èªŒ
- `src/api/auth-middleware.ts:16` - Token é©—è­‰æ—¥èªŒ
- `functions/api/v1/**/*.ts` - å„ API ç«¯é»çš„èª¿è©¦æ—¥èªŒ

```typescript
// âŒ ç•¶å‰ä»£ç¢¼
console.log('[InstructorApp] æ¥æ”¶åˆ°çš„æ•¸æ“š:', body)
console.log('Router guard check:', { to, isAuthenticated })
console.log('[verifyToken] Success with secret:', secret)
```

**å•é¡Œ**:
- ç”Ÿç”¢ç’°å¢ƒæ´©éœ²æ•æ„Ÿä¿¡æ¯ (token, secret, ç”¨æˆ¶æ•¸æ“š)
- å½±éŸ¿æ€§èƒ½ (å¤§é‡æ—¥èªŒè¼¸å‡º)
- æ—¥èªŒé›£ä»¥ç®¡ç†å’Œéæ¿¾

**ä¿®å¾©æ–¹æ¡ˆ**:

```typescript
// âœ… å¯¦ç¾æ¢ä»¶æ—¥èªŒç³»çµ±

// src/utils/logger.ts
type LogLevel = 'debug' | 'info' | 'warn' | 'error'

class Logger {
  private isDev: boolean
  private isProd: boolean
  
  constructor() {
    this.isDev = import.meta.env.DEV || process.env.NODE_ENV === 'development'
    this.isProd = import.meta.env.PROD || process.env.NODE_ENV === 'production'
  }
  
  /**
   * èª¿è©¦æ—¥èªŒ - åƒ…é–‹ç™¼ç’°å¢ƒ
   */
  debug(message: string, ...args: any[]) {
    if (this.isDev) {
      console.log(`[DEBUG] ${message}`, ...args)
    }
  }
  
  /**
   * ä¿¡æ¯æ—¥èªŒ - é–‹ç™¼ç’°å¢ƒè¼¸å‡ºåˆ° console,ç”Ÿç”¢ç’°å¢ƒå¯ç™¼é€åˆ°æ—¥èªŒæœå‹™
   */
  info(message: string, ...args: any[]) {
    if (this.isDev) {
      console.info(`[INFO] ${message}`, ...args)
    } else if (this.isProd) {
      // TODO: ç™¼é€åˆ°æ—¥èªŒæœå‹™ (å¦‚ Cloudflare Analytics, Sentry)
      this.sendToLogService('info', message, args)
    }
  }
  
  /**
   * è­¦å‘Šæ—¥èªŒ - å§‹çµ‚è¨˜éŒ„
   */
  warn(message: string, ...args: any[]) {
    console.warn(`[WARN] ${message}`, ...args)
    
    if (this.isProd) {
      this.sendToLogService('warn', message, args)
    }
  }
  
  /**
   * éŒ¯èª¤æ—¥èªŒ - å§‹çµ‚è¨˜éŒ„
   */
  error(message: string, error?: Error | unknown, ...args: any[]) {
    console.error(`[ERROR] ${message}`, error, ...args)
    
    if (this.isProd) {
      this.sendToLogService('error', message, { error, ...args })
    }
  }
  
  /**
   * åˆ†çµ„æ—¥èªŒ - åƒ…é–‹ç™¼ç’°å¢ƒ
   */
  group(label: string) {
    if (this.isDev) {
      console.group(`[GROUP] ${label}`)
    }
  }
  
  groupEnd() {
    if (this.isDev) {
      console.groupEnd()
    }
  }
  
  /**
   * ç™¼é€åˆ°æ—¥èªŒæœå‹™
   */
  private sendToLogService(level: LogLevel, message: string, data: any) {
    // å¯¦ç¾ç™¼é€åˆ° Cloudflare Analytics æˆ–å…¶ä»–æ—¥èªŒæœå‹™
    // å¯ä»¥ä½¿ç”¨ fetch ç™¼é€åˆ°è‡ªå®šç¾©ç«¯é»
    try {
      // ç¤ºä¾‹: ç™¼é€åˆ° Cloudflare Workers Analytics Engine
      if (typeof fetch !== 'undefined') {
        fetch('/api/v1/logs', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            level,
            message,
            data,
            timestamp: new Date().toISOString(),
            userAgent: typeof navigator !== 'undefined' ? navigator.userAgent : undefined
          })
        }).catch(() => {
          // éœé»˜å¤±æ•—,é¿å…æ—¥èªŒè¨˜éŒ„å¤±æ•—å½±éŸ¿ä¸»æµç¨‹
        })
      }
    } catch (error) {
      // éœé»˜å¤±æ•—
    }
  }
}

export const logger = new Logger()
```

**ä½¿ç”¨ç¤ºä¾‹**:

```typescript
// âœ… æ›¿æ›æ‰€æœ‰ console.log
import { logger } from '@/utils/logger'

// è·¯ç”±å®ˆè¡›
router.beforeEach(async (to, from, next) => {
  logger.debug('Router guard check:', {
    to: to.path,
    requiresAuth: to.meta.requiresAuth,
    isAuthenticated
  })
  
  if (to.meta.requiresAuth && !isAuthenticated) {
    logger.info('Redirecting to login: not authenticated')
    next({ name: 'login', query: { redirect: to.fullPath } })
    return
  }
  
  next()
})

// API ä¸­é–“ä»¶
export const authMiddleware: Middleware = async (req, next) => {
  const authHeader = req.headers.authorization
  
  if (!authHeader) {
    logger.warn('Authentication failed: no token provided')
    throw new AuthenticationError('æœªæä¾›èªè­‰ä»¤ç‰Œ')
  }
  
  try {
    const token = authHeader.substring(7)
    const payload = verifyToken(token)
    
    logger.debug('Token verified successfully', { userId: payload.userId })
    
    req.user = mapTokenPayloadToUser(payload)
    return await next()
  } catch (error) {
    logger.error('Token verification failed', error)
    throw new AuthenticationError('èªè­‰ä»¤ç‰Œç„¡æ•ˆæˆ–å·²éæœŸ')
  }
}

// éŒ¯èª¤è™•ç†
try {
  const result = await dangerousOperation()
  logger.info('Operation completed successfully', { result })
} catch (error) {
  logger.error('Operation failed', error, { context: 'additional info' })
  throw error
}
```

**æ‰¹é‡æ›¿æ›å»ºè­°**:

```bash
# ä½¿ç”¨æ­£å‰‡æ›¿æ›æ‰€æœ‰ console.log
# æ³¨æ„: éœ€è¦æ‰‹å‹•å¯©æŸ¥æ¯å€‹æ›¿æ›,åˆ¤æ–·æ‡‰è©²ä½¿ç”¨ debug/info/warn/error

# æŸ¥æ‰¾æ‰€æœ‰ console.log
grep -r "console.log" src/ functions/

# æ›¿æ›ç‚º logger.debug (é–‹ç™¼èª¿è©¦æ—¥èªŒ)
# console.log('Debug:', data) â†’ logger.debug('Debug:', data)

# æ›¿æ›ç‚º logger.info (é‡è¦ä¿¡æ¯)
# console.log('User logged in:', user) â†’ logger.info('User logged in:', user)

# æ›¿æ› console.warn
# console.warn('Warning:', msg) â†’ logger.warn('Warning:', msg)

# æ›¿æ› console.error
# console.error('Error:', err) â†’ logger.error('Error:', err)
```

---

#### å•é¡Œ 2: éŒ¯èª¤è™•ç†ä¸å®Œæ•´

**ç¤ºä¾‹ä½ç½®**:
- `src/services/auth-service.ts:45` - ç©ºçš„ catch å¡Š
- `src/services/course-service.ts:67` - åæ‰éŒ¯èª¤

```typescript
// âŒ ç¤ºä¾‹ 1: ç©ºçš„ catch å¡Š
try {
  const result = await api.call()
} catch (error) {
  // æ²’æœ‰ä»»ä½•è™•ç†
}

// âŒ ç¤ºä¾‹ 2: åæ‰éŒ¯èª¤
async logout() {
  try {
    await apiService.post('/auth/logout')
  } catch (error) {
    console.warn('Logout API call failed:', error)  // åªè¨˜éŒ„,ä¸æ‹‹å‡º
  }
  // æ²’æœ‰æ¸…ç†æœ¬åœ°ç‹€æ…‹
}

// âŒ ç¤ºä¾‹ 3: è¿”å›é»˜èªå€¼ä½†ä¸è¨˜éŒ„éŒ¯èª¤
async getCourses(): Promise<Course[]> {
  try {
    return await apiService.get('/courses')
  } catch (error) {
    return []  // éœé»˜å¤±æ•—
  }
}
```

**å•é¡Œ**:
- éŒ¯èª¤è¢«åæ‰,ç”¨æˆ¶ä¸çŸ¥é“ç™¼ç”Ÿäº†ä»€éº¼
- é›£ä»¥èª¿è©¦å’Œè¿½è¹¤å•é¡Œ
- å¯èƒ½å°è‡´æ•¸æ“šä¸ä¸€è‡´

**ä¿®å¾©æ–¹æ¡ˆ**:

```typescript
// âœ… é©ç•¶è™•ç†éŒ¯èª¤

import { logger } from '@/utils/logger'
import { useAuthStore } from '@/stores/auth'

// ç¤ºä¾‹ 1: è¨˜éŒ„éŒ¯èª¤ä¸¦é‡æ–°æ‹‹å‡º
async function criticalOperation() {
  try {
    const result = await api.call()
    return result
  } catch (error) {
    logger.error('Critical operation failed', error)
    
    // æ ¹æ“šéŒ¯èª¤é¡å‹æ±ºå®šå¦‚ä½•è™•ç†
    if (error instanceof NetworkError) {
      throw new UserFacingError('ç¶²çµ¡é€£æ¥å¤±æ•—,è«‹æª¢æŸ¥ç¶²çµ¡è¨­ç½®')
    }
    
    throw error  // é‡æ–°æ‹‹å‡º,è®“ä¸Šå±¤è™•ç†
  }
}

// ç¤ºä¾‹ 2: åˆç†çš„éŒ¯èª¤é™ç´š
async function logout() {
  const authStore = useAuthStore()
  
  try {
    await apiService.post('/auth/logout')
    logger.info('Logout API call successful')
  } catch (error) {
    // å³ä½¿ API å¤±æ•—,ä¹Ÿæ‡‰è©²æ¸…é™¤æœ¬åœ°ç‹€æ…‹
    logger.error('Logout API call failed, clearing local state anyway', error)
  } finally {
    // å§‹çµ‚æ¸…é™¤æœ¬åœ°ç‹€æ…‹
    authStore.clearAuth()
    sessionStorage.clear()
    localStorage.removeItem('auth_token')
    localStorage.removeItem('auth_user')
  }
}

// ç¤ºä¾‹ 3: è¿”å›é»˜èªå€¼ä½†é€šçŸ¥ç”¨æˆ¶
async function getCourses(filters?: CourseFilters): Promise<Course[]> {
  const authStore = useAuthStore()
  
  try {
    const response = await apiService.get<Course[]>('/courses', { params: filters })
    return response
  } catch (error) {
    logger.error('Failed to fetch courses', error)
    
    // è¨­ç½®ç”¨æˆ¶å‹å¥½çš„éŒ¯èª¤æ¶ˆæ¯
    if (error instanceof NetworkError) {
      authStore.setError('ç„¡æ³•è¼‰å…¥èª²ç¨‹åˆ—è¡¨,è«‹æª¢æŸ¥ç¶²çµ¡é€£æ¥')
    } else {
      authStore.setError('è¼‰å…¥èª²ç¨‹åˆ—è¡¨å¤±æ•—,è«‹ç¨å¾Œå†è©¦')
    }
    
    // è¿”å›ç©ºåˆ—è¡¨ä½œç‚ºé™ç´š
    return []
  }
}

// ç¤ºä¾‹ 4: éŒ¯èª¤é‚Šç•Œè™•ç†
async function handleUserAction() {
  try {
    await someOperation()
  } catch (error) {
    if (error instanceof ValidationError) {
      // è¡¨å–®é©—è­‰éŒ¯èª¤ - é¡¯ç¤ºçµ¦ç”¨æˆ¶
      showValidationErrors(error.fields)
    } else if (error instanceof AuthenticationError) {
      // èªè­‰éŒ¯èª¤ - è·³è½‰ç™»å…¥
      router.push('/login')
    } else if (error instanceof PermissionError) {
      // æ¬Šé™éŒ¯èª¤ - é¡¯ç¤ºæç¤º
      showErrorToast('æ‚¨æ²’æœ‰æ¬Šé™åŸ·è¡Œæ­¤æ“ä½œ')
    } else {
      // æœªçŸ¥éŒ¯èª¤ - è¨˜éŒ„ä¸¦é¡¯ç¤ºé€šç”¨æ¶ˆæ¯
      logger.error('Unexpected error in user action', error)
      showErrorToast('æ“ä½œå¤±æ•—,è«‹ç¨å¾Œå†è©¦')
    }
  }
}
```

**å…¨å±€éŒ¯èª¤è™•ç†å™¨**:

```typescript
// src/utils/global-error-handler.ts
import { logger } from './logger'
import { useAuthStore } from '@/stores/auth'
import router from '@/router'

export function setupGlobalErrorHandler() {
  // Vue éŒ¯èª¤è™•ç†
  if (typeof window !== 'undefined') {
    window.addEventListener('error', (event) => {
      logger.error('Global error caught', event.error, {
        message: event.message,
        filename: event.filename,
        lineno: event.lineno,
        colno: event.colno
      })
      
      // å¯ä»¥é¸æ“‡é¡¯ç¤ºå‹å¥½çš„éŒ¯èª¤æç¤º
      showGlobalError('æ‡‰ç”¨ç™¼ç”ŸéŒ¯èª¤,è«‹åˆ·æ–°é é¢é‡è©¦')
    })
    
    window.addEventListener('unhandledrejection', (event) => {
      logger.error('Unhandled promise rejection', event.reason, {
        promise: event.promise
      })
      
      showGlobalError('æ“ä½œå¤±æ•—,è«‹é‡è©¦')
    })
  }
}

// åœ¨ main.ts ä¸­èª¿ç”¨
import { setupGlobalErrorHandler } from './utils/global-error-handler'

setupGlobalErrorHandler()
```

---

#### å•é¡Œ 3: TODO è¨»é‡‹æœªè§£æ±º

**çµ±è¨ˆ**: 
é …ç›®ä¸­ç™¼ç¾å¤šå€‹ TODO è¨»é‡‹æ¨™è¨˜æœªå®Œæˆçš„åŠŸèƒ½

**ç¤ºä¾‹**:

```typescript
// âŒ TODO 1: src/api/jobs/index.ts:145
// TODO: è–ªè³‡æŸ¥è©¢éœ€è¦æ ¹æ“šå¯¦éš›çš„ salary æ¬„ä½é€²è¡Œé‡æ§‹

// âŒ TODO 2: src/api/course/enrollments.ts:89
// TODO: é€™äº›æ¬„ä½åœ¨è³‡æ–™åº«ä¸­ä¸å­˜åœ¨ï¼Œæš«æ™‚ç§»é™¤

// âŒ TODO 3: src/api/jobs/management.ts:234
// TODO: experience_level æ¬„ä½ä¸å­˜åœ¨ï¼Œæš«æ™‚ç§»é™¤çµ±è¨ˆ
```

**å»ºè­°**:

1. **æ¸…ç†éæœŸçš„ TODO**:
   - å¦‚æœåŠŸèƒ½å·²å®Œæˆ,åˆªé™¤è¨»é‡‹
   - å¦‚æœåŠŸèƒ½ä¸éœ€è¦äº†,åˆªé™¤è¨»é‡‹

2. **å°‡é‡è¦çš„ TODO è½‰ç‚º Issue**:
   - åœ¨ GitHub/GitLab å‰µå»ºå°æ‡‰çš„ Issue
   - è¨˜éŒ„èƒŒæ™¯ã€éœ€æ±‚ã€æŠ€è¡“æ–¹æ¡ˆ
   - è¨­ç½®å„ªå…ˆç´šå’Œè² è²¬äºº

3. **å®Œæˆé—œéµçš„ TODO**:
   - å„ªå…ˆå®Œæˆå½±éŸ¿åŠŸèƒ½çš„ TODO
   - ä¿®å¾©æ•¸æ“šåº«æ¬„ä½ä¸ä¸€è‡´å•é¡Œ

**æ•¸æ“šåº«æ¬„ä½ä¿®å¾©ç¤ºä¾‹**:

```typescript
// âœ… TODO ä¿®å¾©: çµ±ä¸€è–ªè³‡æ¬„ä½æŸ¥è©¢

// 1. ç¢ºèªæ•¸æ“šåº«å¯¦éš›æ¬„ä½
// åŸ·è¡Œ SQL: \d jobs æŸ¥çœ‹è¡¨çµæ§‹

// 2. å¦‚æœæ¬„ä½åä¸ä¸€è‡´,çµ±ä¸€ä¿®æ”¹
// æ–¹æ¡ˆ A: ä¿®æ”¹æ•¸æ“šåº« (æ¨è–¦)
ALTER TABLE jobs RENAME COLUMN salary_range TO salary;
ALTER TABLE jobs ADD COLUMN min_salary INTEGER;
ALTER TABLE jobs ADD COLUMN max_salary INTEGER;

// æ–¹æ¡ˆ B: ä¿®æ”¹ä»£ç¢¼æŸ¥è©¢
const jobs = await db.query(`
  SELECT 
    id,
    title,
    CASE 
      WHEN salary_range IS NOT NULL THEN salary_range
      WHEN min_salary IS NOT NULL AND max_salary IS NOT NULL 
        THEN min_salary || '-' || max_salary
      ELSE NULL
    END as salary
  FROM jobs
  WHERE ...
`)
```

---

### 4ï¸âƒ£ **æ€§èƒ½å„ªåŒ– (ä¸­å„ªå…ˆç´š)** âš ï¸

#### å•é¡Œ 1: æ½›åœ¨çš„ N+1 æŸ¥è©¢

**ç¤ºä¾‹ä½ç½®**:
- èª²ç¨‹åˆ—è¡¨æŸ¥è©¢è¬›å¸«ä¿¡æ¯
- å·¥ä½œåˆ—è¡¨æŸ¥è©¢å…¬å¸ä¿¡æ¯
- è¨è«–å€æŸ¥è©¢ä½œè€…ä¿¡æ¯

```typescript
// âŒ N+1 æŸ¥è©¢é¢¨éšª
async function getCourses(): Promise<Course[]> {
  // 1 æ¬¡æŸ¥è©¢ç²å–æ‰€æœ‰èª²ç¨‹
  const courses = await db.query<Course>('SELECT * FROM courses WHERE is_active = true')
  
  // N æ¬¡æŸ¥è©¢ç²å–æ¯å€‹èª²ç¨‹çš„è¬›å¸«ä¿¡æ¯
  for (const course of courses) {
    course.instructor = await db.queryOne<User>(
      'SELECT * FROM users WHERE id = $1',
      [course.instructorId]
    )
  }
  
  return courses
}
```

**å•é¡Œ**:
- å¦‚æœæœ‰ 100 å€‹èª²ç¨‹,æœƒåŸ·è¡Œ 101 æ¬¡æ•¸æ“šåº«æŸ¥è©¢
- åš´é‡å½±éŸ¿æ€§èƒ½,éŸ¿æ‡‰æ™‚é–“å¯èƒ½é”åˆ°æ•¸ç§’
- å¢åŠ æ•¸æ“šåº«è² è¼‰

**ä¿®å¾©æ–¹æ¡ˆ**:

```typescript
// âœ… æ–¹æ¡ˆ 1: ä½¿ç”¨ JOIN æŸ¥è©¢

async function getCourses(): Promise<Course[]> {
  const rows = await db.query(`
    SELECT 
      c.id,
      c.title,
      c.description,
      c.price,
      c.duration_hours,
      c.is_active,
      c.created_at,
      u.id as instructor_id,
      u.email as instructor_email,
      u.first_name as instructor_first_name,
      u.last_name as instructor_last_name
    FROM courses c
    LEFT JOIN users u ON c.instructor_id = u.id
    WHERE c.is_active = true
    ORDER BY c.created_at DESC
  `)
  
  // æ˜ å°„çµæœ
  return rows.map(row => ({
    id: row.id,
    title: row.title,
    description: row.description,
    price: row.price,
    durationHours: row.duration_hours,
    isActive: row.is_active,
    createdAt: row.created_at,
    instructor: {
      id: row.instructor_id,
      email: row.instructor_email,
      firstName: row.instructor_first_name,
      lastName: row.instructor_last_name
    }
  }))
}

// âœ… æ–¹æ¡ˆ 2: ä½¿ç”¨æ‰¹é‡æŸ¥è©¢

async function getCourses(): Promise<Course[]> {
  // 1. ç²å–æ‰€æœ‰èª²ç¨‹
  const courses = await db.query<Course>(
    'SELECT * FROM courses WHERE is_active = true ORDER BY created_at DESC'
  )
  
  // 2. æå–æ‰€æœ‰è¬›å¸« ID
  const instructorIds = [...new Set(courses.map(c => c.instructorId))]
  
  // 3. æ‰¹é‡æŸ¥è©¢è¬›å¸«ä¿¡æ¯ (1 æ¬¡æŸ¥è©¢)
  const instructors = await db.query<User>(
    'SELECT * FROM users WHERE id = ANY($1)',
    [instructorIds]
  )
  
  // 4. å»ºç«‹è¬›å¸« Map
  const instructorMap = new Map(instructors.map(i => [i.id, i]))
  
  // 5. çµ„è£çµæœ
  return courses.map(course => ({
    ...course,
    instructor: instructorMap.get(course.instructorId)
  }))
}

// âœ… æ–¹æ¡ˆ 3: ä½¿ç”¨ DataLoader (é©åˆ GraphQL æˆ–è¤‡é›œå ´æ™¯)

import DataLoader from 'dataloader'

// å‰µå»º DataLoader å¯¦ä¾‹
const instructorLoader = new DataLoader(async (ids: readonly number[]) => {
  const instructors = await db.query<User>(
    'SELECT * FROM users WHERE id = ANY($1)',
    [Array.from(ids)]
  )
  
  // DataLoader è¦æ±‚è¿”å›èˆ‡è¼¸å…¥ç›¸åŒé †åºçš„çµæœ
  const instructorMap = new Map(instructors.map(i => [i.id, i]))
  return ids.map(id => instructorMap.get(id) || null)
})

// ä½¿ç”¨
async function getCourses(): Promise<Course[]> {
  const courses = await db.query<Course>(
    'SELECT * FROM courses WHERE is_active = true'
  )
  
  // DataLoader æœƒè‡ªå‹•æ‰¹é‡è™•ç†å’Œç·©å­˜
  const coursesWithInstructors = await Promise.all(
    courses.map(async course => ({
      ...course,
      instructor: await instructorLoader.load(course.instructorId)
    }))
  )
  
  return coursesWithInstructors
}
```

**å…¶ä»–éœ€è¦å„ªåŒ–çš„æŸ¥è©¢**:

```typescript
// âœ… å„ªåŒ–å·¥ä½œåˆ—è¡¨æŸ¥è©¢
async function getJobs(): Promise<Job[]> {
  return await db.query(`
    SELECT 
      j.*,
      u.first_name as employer_first_name,
      u.last_name as employer_last_name,
      COUNT(ja.id) as application_count
    FROM jobs j
    LEFT JOIN users u ON j.employer_id = u.id
    LEFT JOIN job_applications ja ON j.id = ja.job_id
    WHERE j.status = 'active'
    GROUP BY j.id, u.id
    ORDER BY j.created_at DESC
  `)
}

// âœ… å„ªåŒ–è¨è«–å€æŸ¥è©¢
async function getForumTopics(): Promise<ForumTopic[]> {
  return await db.query(`
    SELECT 
      t.*,
      u.first_name as author_first_name,
      u.last_name as author_last_name,
      COUNT(DISTINCT c.id) as comment_count,
      COUNT(DISTINCT l.id) as like_count
    FROM forum_topics t
    LEFT JOIN users u ON t.user_id = u.id
    LEFT JOIN forum_comments c ON t.id = c.topic_id
    LEFT JOIN forum_likes l ON t.id = l.topic_id
    GROUP BY t.id, u.id
    ORDER BY t.updated_at DESC
  `)
}
```

---

#### å•é¡Œ 2: æœªå¯¦ç¾çœŸæ­£çš„äº‹å‹™

**ä½ç½®**: `src/utils/neon-database.ts:110`

```typescript
// âŒ å‡çš„äº‹å‹™ - æ²’æœ‰ BEGIN/COMMIT
async transaction<T>(callback: (db: NeonDatabaseManager) => Promise<T>): Promise<T> {
  // Neon serverless driver å¯èƒ½ä¸æ”¯æŒäº‹å‹™ï¼Œç›´æ¥åŸ·è¡Œå›èª¿
  return await callback(this)
}
```

**å•é¡Œ**:
- å¤šå€‹æ“ä½œæ²’æœ‰åŸå­æ€§ä¿è­‰
- å¯èƒ½å°è‡´æ•¸æ“šä¸ä¸€è‡´
- ä¾‹å¦‚: å ±åèª²ç¨‹æ™‚æ‰£æ¸›åé¡å’Œå‰µå»ºå ±åè¨˜éŒ„æ‡‰è©²åœ¨åŒä¸€äº‹å‹™ä¸­

**ä¿®å¾©æ–¹æ¡ˆ**:

```typescript
// âœ… å¯¦ç¾çœŸæ­£çš„äº‹å‹™

export class NeonDatabaseManager {
  private sql: ReturnType<typeof neon>
  
  async transaction<T>(callback: (db: NeonDatabaseManager) => Promise<T>): Promise<T> {
    // é–‹å§‹äº‹å‹™
    await this.query('BEGIN')
    
    try {
      // åŸ·è¡Œå›èª¿ä¸­çš„æ‰€æœ‰æ“ä½œ
      const result = await callback(this)
      
      // æäº¤äº‹å‹™
      await this.query('COMMIT')
      
      return result
    } catch (error) {
      // ç™¼ç”ŸéŒ¯èª¤æ™‚å›æ»¾
      await this.query('ROLLBACK')
      throw error
    }
  }
}
```

**ä½¿ç”¨äº‹å‹™çš„å ´æ™¯**:

```typescript
// âœ… å ´æ™¯ 1: èª²ç¨‹å ±å (æ‰£æ¸›åé¡ + å‰µå»ºå ±åè¨˜éŒ„)
async function enrollCourse(userId: number, courseId: number) {
  return await db.transaction(async (trx) => {
    // 1. æª¢æŸ¥èª²ç¨‹æ˜¯å¦é‚„æœ‰åé¡
    const course = await trx.queryOne<Course>(
      'SELECT * FROM courses WHERE id = $1 FOR UPDATE',
      [courseId]
    )
    
    if (!course) {
      throw new NotFoundError('èª²ç¨‹ä¸å­˜åœ¨')
    }
    
    if (course.enrolledCount >= course.maxStudents) {
      throw new ValidationError('èª²ç¨‹å·²é¡æ»¿')
    }
    
    // 2. å‰µå»ºå ±åè¨˜éŒ„
    const enrollment = await trx.queryOne<Enrollment>(
      `INSERT INTO enrollments (user_id, course_id, status, created_at)
       VALUES ($1, $2, 'enrolled', NOW())
       RETURNING *`,
      [userId, courseId]
    )
    
    // 3. å¢åŠ å·²å ±åäººæ•¸
    await trx.query(
      'UPDATE courses SET enrolled_count = enrolled_count + 1 WHERE id = $1',
      [courseId]
    )
    
    return enrollment
  })
}

// âœ… å ´æ™¯ 2: è½‰å¸³ (æ‰£æ¬¾ + å…¥å¸³)
async function transferCredits(fromUserId: number, toUserId: number, amount: number) {
  return await db.transaction(async (trx) => {
    // 1. æª¢æŸ¥ç™¼é€æ–¹é¤˜é¡
    const fromUser = await trx.queryOne<User>(
      'SELECT * FROM users WHERE id = $1 FOR UPDATE',
      [fromUserId]
    )
    
    if (!fromUser || fromUser.credits < amount) {
      throw new ValidationError('é¤˜é¡ä¸è¶³')
    }
    
    // 2. æ‰£é™¤ç™¼é€æ–¹é¤˜é¡
    await trx.query(
      'UPDATE users SET credits = credits - $1 WHERE id = $2',
      [amount, fromUserId]
    )
    
    // 3. å¢åŠ æ¥æ”¶æ–¹é¤˜é¡
    await trx.query(
      'UPDATE users SET credits = credits + $1 WHERE id = $2',
      [amount, toUserId]
    )
    
    // 4. è¨˜éŒ„äº¤æ˜“
    await trx.query(
      `INSERT INTO transactions (from_user_id, to_user_id, amount, type, created_at)
       VALUES ($1, $2, $3, 'transfer', NOW())`,
      [fromUserId, toUserId, amount]
    )
    
    return { success: true }
  })
}

// âœ… å ´æ™¯ 3: æ‰¹é‡æ›´æ–°è©•åˆ†
async function updateCourseRatings(courseId: number, ratings: number[]) {
  return await db.transaction(async (trx) => {
    // 1. æ‰¹é‡æ’å…¥è©•åˆ†
    for (const rating of ratings) {
      await trx.query(
        'INSERT INTO ratings (course_id, rating, created_at) VALUES ($1, $2, NOW())',
        [courseId, rating]
      )
    }
    
    // 2. é‡æ–°è¨ˆç®—å¹³å‡è©•åˆ†
    const result = await trx.queryOne<{ avg_rating: number; rating_count: number }>(
      'SELECT AVG(rating) as avg_rating, COUNT(*) as rating_count FROM ratings WHERE course_id = $1',
      [courseId]
    )
    
    // 3. æ›´æ–°èª²ç¨‹è¡¨
    await trx.query(
      'UPDATE courses SET avg_rating = $1, rating_count = $2 WHERE id = $3',
      [result.avg_rating, result.rating_count, courseId]
    )
    
    return result
  })
}
```

**äº‹å‹™éš”é›¢ç´šåˆ¥**:

```typescript
// âœ… è¨­ç½®äº‹å‹™éš”é›¢ç´šåˆ¥
async function transactionWithIsolation<T>(
  callback: (db: NeonDatabaseManager) => Promise<T>,
  isolationLevel: 'READ COMMITTED' | 'REPEATABLE READ' | 'SERIALIZABLE' = 'READ COMMITTED'
): Promise<T> {
  await this.query(`BEGIN TRANSACTION ISOLATION LEVEL ${isolationLevel}`)
  
  try {
    const result = await callback(this)
    await this.query('COMMIT')
    return result
  } catch (error) {
    await this.query('ROLLBACK')
    throw error
  }
}
```

---

#### å•é¡Œ 3: ç¼ºä¹æŸ¥è©¢å„ªåŒ–å’Œç´¢å¼•

**å»ºè­°æ·»åŠ ç´¢å¼•**:

```sql
-- âœ… å¸¸ç”¨æŸ¥è©¢çš„ç´¢å¼•

-- ç”¨æˆ¶ç›¸é—œ
CREATE INDEX idx_users_email ON users(email);
CREATE INDEX idx_users_user_type ON users(user_type);
CREATE INDEX idx_users_is_active ON users(is_active);

-- èª²ç¨‹ç›¸é—œ
CREATE INDEX idx_courses_instructor_id ON courses(instructor_id);
CREATE INDEX idx_courses_is_active ON courses(is_active);
CREATE INDEX idx_courses_course_type ON courses(course_type);
CREATE INDEX idx_courses_created_at ON courses(created_at DESC);

-- å ±åç›¸é—œ
CREATE INDEX idx_enrollments_user_id ON enrollments(user_id);
CREATE INDEX idx_enrollments_course_id ON enrollments(course_id);
CREATE INDEX idx_enrollments_status ON enrollments(status);
CREATE INDEX idx_enrollments_created_at ON enrollments(created_at DESC);

-- å·¥ä½œç›¸é—œ
CREATE INDEX idx_jobs_employer_id ON jobs(employer_id);
CREATE INDEX idx_jobs_status ON jobs(status);
CREATE INDEX idx_jobs_location ON jobs(location);
CREATE INDEX idx_jobs_created_at ON jobs(created_at DESC);

-- è¤‡åˆç´¢å¼•
CREATE INDEX idx_courses_active_type ON courses(is_active, course_type);
CREATE INDEX idx_jobs_status_location ON jobs(status, location);
CREATE INDEX idx_enrollments_user_course ON enrollments(user_id, course_id);

-- å…¨æ–‡æœç´¢ç´¢å¼•
CREATE INDEX idx_courses_search ON courses USING gin(to_tsvector('english', title || ' ' || description));
CREATE INDEX idx_jobs_search ON jobs USING gin(to_tsvector('english', title || ' ' || description));
```

**æŸ¥è©¢å„ªåŒ–ç¤ºä¾‹**:

```typescript
// âœ… ä½¿ç”¨ç´¢å¼•æç¤ºå’Œå„ªåŒ–æŸ¥è©¢

// å„ªåŒ–å‰
const courses = await db.query(`
  SELECT * FROM courses 
  WHERE is_active = true 
  ORDER BY created_at DESC
`)

// å„ªåŒ–å¾Œ: æ·»åŠ  LIMIT å’Œ OFFSET,ä½¿ç”¨ç´¢å¼•
const courses = await db.query(`
  SELECT 
    id, 
    title, 
    description, 
    price, 
    duration_hours,
    instructor_id,
    created_at
  FROM courses 
  WHERE is_active = true 
  ORDER BY created_at DESC
  LIMIT $1 OFFSET $2
`, [limit, offset])

// å„ªåŒ–: ä½¿ç”¨å…¨æ–‡æœç´¢
const courses = await db.query(`
  SELECT 
    *,
    ts_rank(to_tsvector('english', title || ' ' || description), plainto_tsquery($1)) as rank
  FROM courses 
  WHERE 
    is_active = true 
    AND to_tsvector('english', title || ' ' || description) @@ plainto_tsquery($1)
  ORDER BY rank DESC, created_at DESC
  LIMIT 20
`, [searchQuery])
```

---

### 5ï¸âƒ£ **è·¯ç”±å™¨å„ªåŒ– (ä¸­å„ªå…ˆç´š)** âš ï¸

**ä½ç½®**: `src/router/index.ts:502-643`

#### å•é¡Œ: è·¯ç”±å®ˆè¡›éæ–¼è¤‡é›œ

**ç•¶å‰ä»£ç¢¼**: 142 è¡Œçš„ `beforeEach` å®ˆè¡›

```typescript
// âŒ ç•¶å‰ä»£ç¢¼ - éæ–¼è¤‡é›œ
router.beforeEach(async (to, from, next) => {
  // ç­‰å¾…èªè­‰åˆå§‹åŒ– (17 è¡Œ)
  if (!(window as any).__authInitialized) {
    // ...
  }
  
  // æª¢æŸ¥ token (4 è¡Œ)
  const token = sessionStorage.getItem('access_token')
  // ...
  
  // èª¿è©¦æ—¥èªŒ (11 è¡Œ)
  console.log('Router guard check:', {
    // ...
  })
  
  // åŒæ­¥å­˜å„² (48 è¡Œ)
  if (!isAuthenticated) {
    // ...
  }
  
  // èªè­‰æª¢æŸ¥ (5 è¡Œ)
  if (to.meta.requiresAuth && !isAuthenticated) {
    // ...
  }
  
  // è§’è‰²æª¢æŸ¥ (å¤šå€‹ if èªå¥)
  // ...
})
```

**å•é¡Œ**:
- è·è²¬éå¤š,é›£ä»¥ç¶­è­·
- èª¿è©¦æ—¥èªŒæ··åœ¨æ¥­å‹™é‚è¼¯ä¸­
- é‡è¤‡çš„å­˜å„²åŒæ­¥é‚è¼¯

**ä¿®å¾©æ–¹æ¡ˆ**:

```typescript
// âœ… æ‹†åˆ†ç‚ºç¨ç«‹çš„å®ˆè¡›å‡½æ•¸

// guards/auth-init.guard.ts
/**
 * ç¢ºä¿èªè­‰ç³»çµ±å·²åˆå§‹åŒ–
 */
export async function ensureAuthInitialized(): Promise<void> {
  if ((window as any).__authInitialized) {
    return
  }
  
  try {
    await authServiceEnhanced.initializeAuth()
    ;(window as any).__authInitialized = true
    logger.debug('Auth system initialized')
  } catch (error) {
    logger.error('Auth initialization failed', error)
    ;(window as any).__authInitialized = true // æ¨™è¨˜ç‚ºå·²å˜—è©¦
  }
}

// guards/storage-sync.guard.ts
/**
 * åŒæ­¥ sessionStorage å’Œ localStorage çš„èªè­‰ç‹€æ…‹
 */
export function syncAuthStorage(): boolean {
  const sessionToken = sessionStorage.getItem('access_token')
  const localToken = localStorage.getItem('auth_token')
  const sessionUser = sessionStorage.getItem('user')
  const localUser = localStorage.getItem('auth_user')
  
  // å„ªå…ˆä½¿ç”¨ sessionStorage (æ›´æ–°)
  if (sessionToken && sessionUser) {
    logger.debug('Syncing auth from sessionStorage to localStorage')
    localStorage.setItem('auth_token', sessionToken)
    localStorage.setItem('auth_user', sessionUser)
    return true
  }
  
  // é™ç´šåˆ° localStorage
  if (localToken && localUser) {
    logger.debug('Syncing auth from localStorage to sessionStorage')
    sessionStorage.setItem('access_token', localToken)
    sessionStorage.setItem('user', localUser)
    const expiryTime = Date.now() + 60 * 60 * 1000 // 1 hour
    sessionStorage.setItem('token_expiry', expiryTime.toString())
    return true
  }
  
  return false
}

// guards/auth.guard.ts
/**
 * æª¢æŸ¥èªè­‰ç‹€æ…‹
 */
export function checkAuthentication(to: RouteLocationNormalized): NavigationGuardReturn {
  const token = sessionStorage.getItem('access_token')
  const tokenExpiry = sessionStorage.getItem('token_expiry')
  const hasValidToken = token && tokenExpiry && Date.now() < parseInt(tokenExpiry, 10)
  
  const isAuthenticated = authService.isAuthenticated() && hasValidToken
  
  logger.debug('Authentication check', {
    path: to.path,
    isAuthenticated,
    requiresAuth: to.meta.requiresAuth
  })
  
  // éœ€è¦èªè­‰ä½†æœªç™»å…¥
  if (to.meta.requiresAuth && !isAuthenticated) {
    // å˜—è©¦åŒæ­¥å­˜å„²
    const synced = syncAuthStorage()
    
    if (synced && authService.isAuthenticated()) {
      logger.info('Auth recovered from storage')
      return undefined // ç¹¼çºŒå°èˆª
    }
    
    logger.info('Redirecting to login: not authenticated')
    return { name: 'login', query: { redirect: to.fullPath } }
  }
  
  // éœ€è¦è¨ªå®¢èº«ä»½ä½†å·²ç™»å…¥
  if (to.meta.requiresGuest && isAuthenticated) {
    return { name: 'home' }
  }
  
  return undefined
}

// guards/role.guard.ts
/**
 * æª¢æŸ¥ç”¨æˆ¶è§’è‰²æ¬Šé™
 */
export async function checkRolePermission(
  to: RouteLocationNormalized
): Promise<NavigationGuardReturn> {
  const user = authService.getCurrentUser()
  
  if (!user) {
    return undefined
  }
  
  // æª¢æŸ¥ç®¡ç†å“¡æ¬Šé™
  if (to.meta.requiresAdmin && user.userType !== 'admin') {
    logger.warn('Access denied: requires admin role', { userType: user.userType })
    return { name: 'home' }
  }
  
  // æª¢æŸ¥è¬›å¸«æ¬Šé™
  if (to.meta.requiresInstructor) {
    if (!['admin', 'instructor'].includes(user.userType)) {
      logger.warn('Access denied: requires instructor role', { userType: user.userType })
      return { name: 'home' }
    }
    
    // æª¢æŸ¥è¬›å¸«å¯©æ ¸ç‹€æ…‹
    if (user.userType === 'instructor') {
      const authStore = useAuthStore()
      
      if (!authStore.instructorStatus) {
        await authStore.checkInstructorStatus()
      }
      
      if (!authStore.isApprovedInstructor) {
        logger.warn('Access denied: instructor not approved')
        return { name: 'home' }
      }
    }
  }
  
  // æª¢æŸ¥é›‡ä¸»æ¬Šé™
  if (to.meta.requiresEmployer && !['employer', 'instructor'].includes(user.userType)) {
    logger.warn('Access denied: requires employer role', { userType: user.userType })
    return { name: 'home' }
  }
  
  // æª¢æŸ¥æ±‚è·è€…æ¬Šé™
  if (to.meta.requiresJobSeeker && user.userType !== 'job_seeker') {
    logger.warn('Access denied: requires job_seeker role', { userType: user.userType })
    return { name: 'home' }
  }
  
  return undefined
}

// router/index.ts - ç°¡åŒ–çš„è·¯ç”±å®ˆè¡›
router.beforeEach(async (to, from, next) => {
  try {
    // 1. ç¢ºä¿èªè­‰ç³»çµ±å·²åˆå§‹åŒ–
    await ensureAuthInitialized()
    
    // 2. æª¢æŸ¥èªè­‰ç‹€æ…‹
    const authResult = checkAuthentication(to)
    if (authResult) {
      return next(authResult)
    }
    
    // 3. æª¢æŸ¥è§’è‰²æ¬Šé™
    const roleResult = await checkRolePermission(to)
    if (roleResult) {
      return next(roleResult)
    }
    
    // 4. å…è¨±å°èˆª
    next()
  } catch (error) {
    logger.error('Navigation guard error', error)
    next({ name: 'home' })
  }
})
```

**å„ªå‹¢**:
- æ¯å€‹å®ˆè¡›å‡½æ•¸è·è²¬å–®ä¸€,æ˜“æ–¼æ¸¬è©¦
- å¯ä»¥å–®ç¨é‡ç”¨å®ˆè¡›é‚è¼¯
- æ—¥èªŒè¨˜éŒ„çµ±ä¸€ä½¿ç”¨ logger
- ä»£ç¢¼çµæ§‹æ¸…æ™°,æ˜“æ–¼ç¶­è­·

---

### 6ï¸âƒ£ **é¡å‹å®‰å…¨æ”¹é€² (ä½å„ªå…ˆç´š)** â„¹ï¸

#### å•é¡Œ: éå¤šä½¿ç”¨ `any` é¡å‹

**ç¤ºä¾‹ä½ç½®**:

```typescript
// âŒ src/utils/database.ts:42
async query(queryOptions: QueryOptions): Promise<any> {
  // ...
}

// âŒ src/main.ts:99
const { getCLS, getFID, getFCP, getLCP, getTTFB } = mod as any

// âŒ src/api/auth-middleware.ts:16
const result = jwt.verify(token, secret as string) as any
```

**å•é¡Œ**:
- å¤±å»é¡å‹æª¢æŸ¥
- IDE ç„¡æ³•æä¾›æ™ºèƒ½æç¤º
- å®¹æ˜“å¼•å…¥é‹è¡Œæ™‚éŒ¯èª¤

**ä¿®å¾©æ–¹æ¡ˆ**:

```typescript
// âœ… å®šç¾©å…·é«”çš„é¡å‹

// 1. æ•¸æ“šåº«æŸ¥è©¢çµæœé¡å‹
interface QueryResult<T> {
  rows: T[]
  rowCount: number
  command: string
}

async query<T = any>(queryOptions: QueryOptions): Promise<QueryResult<T>> {
  const client = await this.pool.connect()
  try {
    const result = await client.query(queryOptions.text, queryOptions.values)
    return {
      rows: result.rows,
      rowCount: result.rowCount,
      command: result.command
    }
  } finally {
    client.release()
  }
}

// ä½¿ç”¨
const result = await db.query<User>({ text: 'SELECT * FROM users WHERE id = $1', values: [1] })
const users: User[] = result.rows

// 2. Web Vitals é¡å‹
import type { Metric } from 'web-vitals'

// æˆ–è€…æ‰‹å‹•å®šç¾©
interface WebVitalsMetric {
  name: string
  value: number
  rating: 'good' | 'needs-improvement' | 'poor'
  delta: number
  id: string
}

import('web-vitals').then((mod) => {
  const { getCLS, getFID, getFCP, getLCP, getTTFB } = mod
  
  const logMetric = (metric: Metric) => {
    logger.debug(`${metric.name}:`, metric.value)
  }
  
  getCLS(logMetric)
  getFID(logMetric)
  getFCP(logMetric)
  getLCP(logMetric)
  getTTFB(logMetric)
})

// 3. JWT Payload é¡å‹
interface JWTPayload {
  userId: number
  email: string
  userType: 'admin' | 'instructor' | 'employer' | 'job_seeker'
  firstName: string
  lastName: string
  iat: number
  exp: number
}

const verifyToken = (token: string): JWTPayload => {
  const secret = process.env.JWT_SECRET
  
  if (!secret) {
    throw new AuthenticationError('JWT secret not configured')
  }
  
  try {
    const payload = jwt.verify(token, secret) as JWTPayload
    return payload
  } catch (error) {
    throw new AuthenticationError('èªè­‰ä»¤ç‰Œç„¡æ•ˆæˆ–å·²éæœŸ')
  }
}
```

**å•Ÿç”¨åš´æ ¼æ¨¡å¼**:

```json
// tsconfig.json
{
  "compilerOptions": {
    "strict": true,
    "noImplicitAny": true,
    "strictNullChecks": true,
    "strictFunctionTypes": true,
    "strictBindCallApply": true,
    "strictPropertyInitialization": true,
    "noImplicitThis": true,
    "alwaysStrict": true
  }
}
```

---

## ğŸ“‹ å„ªå…ˆç´šè¡Œå‹•æ¸…å–®

### ğŸ”´ ç«‹å³è™•ç† (å®‰å…¨ç›¸é—œ)

#### 1. ç§»é™¤ç¡¬ç·¨ç¢¼çš„ JWT Secret
- **æ–‡ä»¶**: `src/api/auth-middleware.ts:14-18`
- **è¡Œå‹•**: åˆªé™¤ç¡¬ç·¨ç¢¼çš„ `'3939889'` å’Œ `'test-secret'`
- **é©—è­‰**: ç¢ºä¿åªä½¿ç”¨ç’°å¢ƒè®Šé‡ `process.env.JWT_SECRET`

#### 2. é™åˆ¶ CORS ä¾†æºç™½åå–®
- **æ–‡ä»¶**: `functions/_middleware.ts:13`
- **è¡Œå‹•**: æ›¿æ› `Access-Control-Allow-Origin: *` ç‚ºç™½åå–®æ©Ÿåˆ¶
- **é…ç½®**: åœ¨ç’°å¢ƒè®Šé‡ä¸­é…ç½®å…è¨±çš„ä¾†æº

#### 3. ä¿®å¾© SQL æ³¨å…¥é¢¨éšª
- **æ–‡ä»¶**: `src/utils/database.ts:75`
- **è¡Œå‹•**: æ·»åŠ è¡¨åç™½åå–®é©—è­‰æˆ–ä½¿ç”¨åƒæ•¸åŒ–æŸ¥è©¢
- **æ¸¬è©¦**: ä½¿ç”¨æƒ¡æ„è¼¸å…¥æ¸¬è©¦æ˜¯å¦èƒ½æ³¨å…¥

---

### âš ï¸ è¿‘æœŸè™•ç† (æ¶æ§‹å„ªåŒ–)

#### 4. çµ±ä¸€æ•¸æ“šåº«æŠ½è±¡å±¤
- **ç¯„åœ**: `src/config/database.ts`, `src/utils/database.ts`, `src/utils/neon-database.ts`
- **è¡Œå‹•**: 
  - å‰µå»ºçµ±ä¸€çš„ `DatabaseAdapter` æ¥å£
  - å¯¦ç¾ `NeonAdapter` å’Œ `PostgresAdapter`
  - ä½¿ç”¨å·¥å» å‡½æ•¸æ ¹æ“šç’°å¢ƒé¸æ“‡é©é…å™¨
- **é æœŸ**: æ¸›å°‘ 60% é‡è¤‡ä»£ç¢¼

#### 5. ç§»é™¤é›™é‡ API ç³»çµ±
- **ç¯„åœ**: `src/api/` (82 å€‹æ–‡ä»¶) vs `functions/api/v1/` (35 å€‹æ–‡ä»¶)
- **è¡Œå‹•**:
  - ä¿ç•™ `functions/api/v1/` ä½œç‚ºå”¯ä¸€å¾Œç«¯ API
  - ç§»é™¤ `src/api/` ä¸­çš„è·¯ç”±å®šç¾©
  - ä¿ç•™ `src/services/` ä½œç‚ºå‰ç«¯èª¿ç”¨å±¤
- **é æœŸ**: æ¸›å°‘ 40% å†—é¤˜ä»£ç¢¼

#### 6. çµ±ä¸€å‘½åç´„å®š
- **ç¯„åœ**: æ•´å€‹é …ç›®
- **è¡Œå‹•**:
  - å…¨å±€æœç´¢ `user_type`, `first_name` ç­‰ä¸‹åŠƒç·šå‘½å
  - æ›¿æ›ç‚ºé§å³°å‘½å `userType`, `firstName`
  - åœ¨æ•¸æ“šåº«æ˜ å°„å±¤çµ±ä¸€è½‰æ›
- **å·¥å…·**: ä½¿ç”¨ `toCamelCase` å·¥å…·å‡½æ•¸

#### 7. å¯¦ç¾æ¢ä»¶æ—¥èªŒç³»çµ±
- **ç¯„åœ**: æ•´å€‹é …ç›® (120+ console èªå¥)
- **è¡Œå‹•**:
  - å‰µå»º `src/utils/logger.ts`
  - æ›¿æ›æ‰€æœ‰ `console.log` ç‚º `logger.debug`
  - æ›¿æ› `console.error` ç‚º `logger.error`
- **é æœŸ**: æ¸›å°‘ç”Ÿç”¢ç’°å¢ƒæ—¥èªŒ 90%

#### 8. å¯¦ç¾çœŸæ­£çš„æ•¸æ“šåº«äº‹å‹™
- **æ–‡ä»¶**: `src/utils/neon-database.ts:110`
- **è¡Œå‹•**:
  - å¯¦ç¾ `BEGIN`, `COMMIT`, `ROLLBACK`
  - åœ¨é—œéµæ¥­å‹™é‚è¼¯ä¸­ä½¿ç”¨äº‹å‹™
  - æ·»åŠ äº‹å‹™éš”é›¢ç´šåˆ¥é…ç½®
- **æ¸¬è©¦**: æ¸¬è©¦ä¸¦ç™¼å ´æ™¯ä¸‹çš„æ•¸æ“šä¸€è‡´æ€§

---

### â„¹ï¸ æŒçºŒæ”¹é€² (ä»£ç¢¼è³ªé‡)

#### 9. é‡æ§‹è·¯ç”±å®ˆè¡›
- **æ–‡ä»¶**: `src/router/index.ts:502-643`
- **è¡Œå‹•**:
  - æ‹†åˆ†ç‚º `ensureAuthInitialized`, `checkAuthentication`, `checkRolePermission`
  - ç§»å‹•åˆ° `src/guards/` ç›®éŒ„
  - ç°¡åŒ–ä¸»è·¯ç”±å®ˆè¡›é‚è¼¯
- **é æœŸ**: æå‡å¯æ¸¬è©¦æ€§å’Œå¯ç¶­è­·æ€§

#### 10. è§£æ±º TODO è¨»é‡‹
- **ç¯„åœ**: æ•´å€‹é …ç›®
- **è¡Œå‹•**:
  - å…¨å±€æœç´¢ `TODO`
  - ä¿®å¾©æ•¸æ“šåº«æ¬„ä½ä¸ä¸€è‡´å•é¡Œ
  - å°‡é‡è¦çš„ TODO è½‰ç‚º GitHub Issue
- **å„ªå…ˆ**: ä¿®å¾©å½±éŸ¿åŠŸèƒ½çš„ TODO

#### 11. æ”¹é€²éŒ¯èª¤è™•ç†
- **ç¯„åœ**: `src/services/`, `src/api/`
- **è¡Œå‹•**:
  - æ›¿æ›ç©ºçš„ catch å¡Š
  - åœ¨ finally ä¸­æ¸…ç†è³‡æº
  - è¨˜éŒ„éŒ¯èª¤ä¸¦é‡æ–°æ‹‹å‡º
- **æ¸¬è©¦**: æ¸¬è©¦å„ç¨®éŒ¯èª¤å ´æ™¯

#### 12. å„ªåŒ– N+1 æŸ¥è©¢
- **ç¯„åœ**: èª²ç¨‹ã€å·¥ä½œã€è¨è«–å€ç­‰æŸ¥è©¢
- **è¡Œå‹•**:
  - ä½¿ç”¨ JOIN æŸ¥è©¢
  - å¯¦ç¾æ‰¹é‡æŸ¥è©¢
  - è€ƒæ…®ä½¿ç”¨ DataLoader
- **é æœŸ**: æå‡ API éŸ¿æ‡‰é€Ÿåº¦ 50-80%

#### 13. å¢å¼·é¡å‹å®‰å…¨
- **ç¯„åœ**: æ•´å€‹é …ç›®
- **è¡Œå‹•**:
  - æ›¿æ› `any` ç‚ºå…·é«”é¡å‹
  - å®šç¾© `QueryResult<T>`, `JWTPayload` ç­‰é¡å‹
  - å•Ÿç”¨ TypeScript åš´æ ¼æ¨¡å¼
- **é æœŸ**: æ¸›å°‘é‹è¡Œæ™‚éŒ¯èª¤ 30%

---

## ğŸ“Š é æœŸæ•ˆæœ

| å„ªåŒ–é …ç›® | ç•¶å‰ç‹€æ…‹ | é æœŸæ”¹å–„ | å„ªå…ˆç´š |
|---------|---------|---------|--------|
| **ç§»é™¤é›™é‡ API** | 117 å€‹ API æ–‡ä»¶ | æ¸›å°‘ 40% å†—é¤˜ä»£ç¢¼ | ğŸ”´ é«˜ |
| **çµ±ä¸€æ•¸æ“šåº«å±¤** | 4 å€‹æŠ½è±¡å±¤ | æ¸›å°‘ 60% é‡è¤‡ä»£ç¢¼ | ğŸ”´ é«˜ |
| **ä¿®å¾©å®‰å…¨å•é¡Œ** | 3 å€‹åš´é‡éš±æ‚£ | æ¶ˆé™¤å®‰å…¨é¢¨éšª | ğŸ”´ é«˜ |
| **æ¢ä»¶æ—¥èªŒ** | 120+ console | æ¸›å°‘ç”Ÿç”¢æ—¥èªŒ 90% | âš ï¸ ä¸­ |
| **N+1 æŸ¥è©¢å„ªåŒ–** | å¤šå€‹ N+1 é¢¨éšª | API éŸ¿æ‡‰é€Ÿåº¦æå‡ 50-80% | âš ï¸ ä¸­ |
| **äº‹å‹™å¯¦ç¾** | å‡äº‹å‹™ | ä¿è­‰æ•¸æ“šä¸€è‡´æ€§ | âš ï¸ ä¸­ |
| **è·¯ç”±å®ˆè¡›é‡æ§‹** | 142 è¡Œè¤‡é›œé‚è¼¯ | æå‡å¯ç¶­è­·æ€§ | â„¹ï¸ ä½ |
| **é¡å‹å®‰å…¨** | å¤šè™•ä½¿ç”¨ any | æ¸›å°‘é‹è¡Œæ™‚éŒ¯èª¤ 30% | â„¹ï¸ ä½ |

---

## ğŸ’¡ é …ç›®äº®é»

é …ç›®æ•´é«”æ¶æ§‹è¨­è¨ˆè‰¯å¥½,ä½¿ç”¨äº†ç¾ä»£åŒ–çš„æŠ€è¡“æ£§å’Œæœ€ä½³å¯¦è¸:

### âœ… å„ªå‹¢

1. **ç¾ä»£åŒ–æŠ€è¡“æ£§**
   - Vue 3 Composition API
   - TypeScript é¡å‹ç³»çµ±
   - Cloudflare Edge Computing
   - Neon Serverless PostgreSQL

2. **è‰¯å¥½çš„é …ç›®çµ„ç¹”**
   - æ¸…æ™°çš„æ¨¡çµ„åŒ–çµæ§‹ (223 å€‹æ–‡ä»¶)
   - åŠŸèƒ½æŒ‰é ˜åŸŸåˆ†çµ„
   - çµ„ä»¶å’Œè¦–åœ–åˆ†é›¢

3. **çµ±ä¸€çš„éŒ¯èª¤è™•ç†æ©Ÿåˆ¶**
   - `ErrorCode` æšèˆ‰
   - `ApiError` è‡ªå®šç¾©éŒ¯èª¤é¡
   - `withErrorHandler` åŒ…è£å™¨æ¨¡å¼

4. **Repository æ¨¡å¼æ‡‰ç”¨**
   - 23 å€‹ Repository é¡
   - çµ±ä¸€çš„ CRUD æ¥å£
   - æ•¸æ“šè¨ªå•å±¤æŠ½è±¡

5. **å®Œå–„çš„ä¸­é–“ä»¶æ¶æ§‹**
   - èªè­‰ä¸­é–“ä»¶
   - æ¬Šé™æª¢æŸ¥ä¸­é–“ä»¶
   - é€Ÿç‡é™åˆ¶
   - éŸ¿æ‡‰å„ªåŒ–
   - å®‰å…¨é ­

6. **è‡ªå‹•é‡è©¦æ©Ÿåˆ¶**
   - 500 éŒ¯èª¤è‡ªå‹•é‡è©¦ (æœ€å¤š 3 æ¬¡)
   - æŒ‡æ•¸é€€é¿ç­–ç•¥

---

## ğŸš€ å¯¦æ–½å»ºè­°

### éšæ®µ 1: å®‰å…¨ä¿®å¾© (ç¬¬ 1 é€±)
- [ ] ç§»é™¤ç¡¬ç·¨ç¢¼ JWT Secret
- [ ] å¯¦æ–½ CORS ç™½åå–®
- [ ] ä¿®å¾© SQL æ³¨å…¥æ¼æ´
- [ ] å®‰å…¨å¯©è¨ˆå’Œæ¸¬è©¦

### éšæ®µ 2: æ¶æ§‹å„ªåŒ– (ç¬¬ 2-3 é€±)
- [ ] çµ±ä¸€æ•¸æ“šåº«æŠ½è±¡å±¤
- [ ] å¯¦ç¾çœŸæ­£çš„äº‹å‹™æ”¯æŒ
- [ ] ç§»é™¤é›™é‡ API ç³»çµ±
- [ ] çµ±ä¸€å‘½åç´„å®š

### éšæ®µ 3: ä»£ç¢¼è³ªé‡ (ç¬¬ 4-5 é€±)
- [ ] å¯¦ç¾æ¢ä»¶æ—¥èªŒç³»çµ±
- [ ] æ”¹é€²éŒ¯èª¤è™•ç†
- [ ] é‡æ§‹è·¯ç”±å®ˆè¡›
- [ ] è§£æ±º TODO è¨»é‡‹

### éšæ®µ 4: æ€§èƒ½å„ªåŒ– (ç¬¬ 6-7 é€±)
- [ ] å„ªåŒ– N+1 æŸ¥è©¢
- [ ] æ·»åŠ æ•¸æ“šåº«ç´¢å¼•
- [ ] å¯¦ç¾æŸ¥è©¢ç·©å­˜
- [ ] æ€§èƒ½æ¸¬è©¦å’Œèª¿å„ª

### éšæ®µ 5: é¡å‹å®‰å…¨ (ç¬¬ 8 é€±)
- [ ] æ›¿æ› any é¡å‹
- [ ] å•Ÿç”¨ TypeScript åš´æ ¼æ¨¡å¼
- [ ] å®Œå–„é¡å‹å®šç¾©
- [ ] é¡å‹å®‰å…¨æ¸¬è©¦

---

## ğŸ“š åƒè€ƒè³‡æº

- [OWASP Top 10](https://owasp.org/www-project-top-ten/) - Web æ‡‰ç”¨å®‰å…¨é¢¨éšª
- [TypeScript Handbook](https://www.typescriptlang.org/docs/handbook/intro.html) - TypeScript å®˜æ–¹æ–‡æª”
- [Vue 3 Best Practices](https://vuejs.org/guide/best-practices/production-deployment.html) - Vue 3 æœ€ä½³å¯¦è¸
- [PostgreSQL Performance Tips](https://wiki.postgresql.org/wiki/Performance_Optimization) - PostgreSQL æ€§èƒ½å„ªåŒ–
- [Cloudflare Workers](https://developers.cloudflare.com/workers/) - Cloudflare Workers æ–‡æª”

---

**ç”Ÿæˆæ™‚é–“**: 2025-11-15  
**æƒææ–‡ä»¶æ•¸**: 223 å€‹  
**æƒæä»£ç¢¼è¡Œæ•¸**: ~12,000+ è¡Œ  
**ç™¼ç¾å•é¡Œæ•¸**: 13 å€‹ä¸»è¦å•é¡Œ  
**å„ªåŒ–å»ºè­°æ•¸**: 13 é …
