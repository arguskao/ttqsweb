# 專案代碼優化建議報告

這份報告基於對 `src/main.ts`、`src/App.vue` 及認證相關邏輯的分析，提供了具體的優化建議。

## 1. 入口文件 (`src/main.ts`) 優化

目前 `main.ts` 承擔了過多的職責，違反了單一職責原則 (Single Responsibility Principle)。

### 建議改進項目
- **拆分初始化邏輯**：
  - **PWA 註冊**：將 `serviceWorker` 註冊代碼提取到 `src/utils/pwa-registration.ts`。
  - **效能監控**：將 `web-vitals` 和自定義監控（記憶體、Scroll Depth）提取到 `src/utils/performance-monitoring.ts`。
  - **認證初始化**：將 `authServiceEnhanced.initializeAuth()` 封裝成獨立函數。

- **優化啟動流程**：
  - **避免畫面閃爍**：目前 `app.mount('#app')` 是同步執行，而認證初始化是非同步的。這會導致用戶先看到「未登入」狀態，隨後跳轉。
  - **解決方案**：建議使用 `await initializeAuth()` 等待認證狀態確認後，再執行 `app.mount()`，或在 `App.vue` 使用全域 `isReady` 狀態控制 Loading 畫面。

## 2. 根組件 (`src/App.vue`) 優化

### 建議改進項目
- **移除冗餘的認證載入**：
  - `main.ts` 已經呼叫了 `initializeAuth()`，`App.vue` 中的 `authStore.loadAuth()` 是重複執行，建議移除。

- **優化 `KeepAlive` 邏輯**：
  - 目前的 template 寫法較為雜亂：`<KeepAlive :include="route.meta?.keepAlive ? [route.name as string] : []">`。
  - **解決方案**：使用 `computed` 屬性計算 `cachedViews`，讓 template 保持乾淨易讀。

## 3. 認證服務 (`src/services/auth-service-enhanced.ts`) 優化

### 建議改進項目
- **減少重複代碼 (Boilerplate)**：
  - 許多方法重複了 `setLoading(true)` ... `try-catch` ... `finally` 的模式。
  - **解決方案**：使用高階函數或裝飾器來統一處理 Loading 狀態與錯誤捕捉。

- **Token 存儲策略**：
  - 目前混合使用 `sessionStorage` (Access Token) 和 `localStorage` (Refresh Token)。
  - **安全性建議**：建議後端配合實作 `httpOnly` Cookie 來存儲 Refresh Token，以防止 XSS 攻擊竊取 Token。

## 4. TypeScript 類型定義

### 建議改進項目
- **避免使用 `any`**：
  - 代碼中使用了 `(window as any).__authInitialized`。
  - **解決方案**：建立 `src/types/global.d.ts` 擴充 `Window` 介面，定義全域變數類型，以獲得更好的 IDE 提示並減少錯誤。
