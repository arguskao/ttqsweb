<!doctype html>
<html>
  <head>
    <title>認證狀態調試</title>
  </head>
  <body>
    <h1>認證狀態調試</h1>
    <div id="debug-info"></div>

    <script>
      function debugAuth() {
        const debugInfo = document.getElementById('debug-info')

        const sessionToken = sessionStorage.getItem('access_token')
        const localToken = localStorage.getItem('auth_token')
        const sessionUser = sessionStorage.getItem('user')
        const localUser = localStorage.getItem('auth_user')
        const tokenExpiry = sessionStorage.getItem('token_expiry')
        const refreshToken = localStorage.getItem('refresh_token')

        const now = Date.now()
        const isExpired = tokenExpiry ? now > parseInt(tokenExpiry) : '未知'

        debugInfo.innerHTML = `
                <h2>Token 狀態</h2>
                <p><strong>Session Token:</strong> ${sessionToken ? '存在' : '不存在'}</p>
                <p><strong>Local Token:</strong> ${localToken ? '存在' : '不存在'}</p>
                <p><strong>Token 過期時間:</strong> ${tokenExpiry ? new Date(parseInt(tokenExpiry)).toLocaleString() : '未設置'}</p>
                <p><strong>Token 是否過期:</strong> ${isExpired}</p>
                <p><strong>Refresh Token:</strong> ${refreshToken ? '存在' : '不存在'}</p>
                
                <h2>用戶信息</h2>
                <p><strong>Session User:</strong> ${sessionUser || '無'}</p>
                <p><strong>Local User:</strong> ${localUser || '無'}</p>
                
                <h2>詳細信息</h2>
                <pre>Session Token: ${sessionToken || 'null'}</pre>
                <pre>Local Token: ${localToken || 'null'}</pre>
                <pre>Session User: ${sessionUser || 'null'}</pre>
                <pre>Local User: ${localUser || 'null'}</pre>
                
                <h2>操作</h2>
                <button onclick="clearAll()">清除所有存儲</button>
                <button onclick="testAPI()">測試API調用</button>
            `
      }

      function clearAll() {
        sessionStorage.clear()
        localStorage.clear()
        alert('已清除所有存儲，請重新登入')
        location.reload()
      }

      async function testAPI() {
        const token = sessionStorage.getItem('access_token')
        if (!token) {
          alert('沒有找到token')
          return
        }

        try {
          const response = await fetch(
            'https://bf7b8504.pharmacy-assistant-academy.pages.dev/api/v1/course-applications',
            {
              headers: {
                Authorization: `Bearer ${token}`,
                'Content-Type': 'application/json'
              }
            }
          )

          const data = await response.json()
          alert(`API響應: ${response.status} - ${JSON.stringify(data, null, 2)}`)
        } catch (error) {
          alert(`API錯誤: ${error.message}`)
        }
      }

      // 頁面載入時執行調試
      debugAuth()

      // 每5秒更新一次
      setInterval(debugAuth, 5000)
    </script>
  </body>
</html>
