# 機密文件提示功能

## 功能說明

當使用者嘗試下載失效或無法訪問的文件時，系統會顯示一個友善的提示視窗，告知使用者「此為機密文件，請洽站長」，而不是顯示 404 錯誤頁面。

## 修改內容

### 前端修改 (`src/views/DocumentsView.vue`)

1. **新增機密文件提示模態視窗**
   - 使用 Bulma 的 modal 元件
   - 警告圖示和黃色主題
   - 清楚的提示訊息

2. **改進下載流程**
   - 下載前先呼叫 `/documents/:id/validate` 驗證檔案
   - 如果檔案無效，顯示機密文件提示
   - 如果檔案有效，才開啟下載連結

3. **錯誤處理**
   - 捕捉 `FILE_UNAVAILABLE` 和 `NOT_FOUND` 錯誤碼
   - 顯示機密文件提示而非一般錯誤訊息

4. **新增狀態管理**
   ```typescript
   const showConfidentialModal = ref(false)
   ```

### 後端修改 (`src/api/documents/downloads.ts`)

1. **新增驗證端點** (`GET /api/v1/documents/:id/validate`)
   - 檢查文件是否存在
   - 檢查 `file_url` 是否為空或無效（如 `#`）
   - 使用 HEAD 請求驗證 URL 是否可訪問
   - 返回驗證結果（isValid, reason）

2. **檔案 URL 驗證**
   - 在下載端點也保留 URL 驗證
   - 檢查 `file_url` 是否為空
   - 檢查 `file_url` 是否為無效連結
   - 返回 `FILE_UNAVAILABLE` 錯誤碼

## 觸發條件

機密文件提示會在以下情況顯示：

1. **驗證階段失敗**
   - 文件不存在於資料庫
   - 文件的 `file_url` 為空或 `#`
   - URL 返回 404 或其他錯誤狀態碼
   - URL 無法訪問（網路錯誤、超時等）

2. **下載階段失敗**
   - 後端返回 `FILE_UNAVAILABLE` 或 `NOT_FOUND` 錯誤碼
   - 後端返回「文件不存在或不可下載」的錯誤訊息

## 工作流程

```
使用者點擊下載
    ↓
呼叫 /documents/:id/validate
    ↓
檢查文件是否存在 ──→ 否 ──→ 顯示機密文件提示
    ↓ 是
檢查 file_url 是否有效 ──→ 否 ──→ 顯示機密文件提示
    ↓ 是
HEAD 請求驗證 URL ──→ 失敗 ──→ 顯示機密文件提示
    ↓ 成功
呼叫 /documents/:id/download
    ↓
開啟下載連結
    ↓
更新下載次數
```

## 使用者體驗

### 之前
- 點擊下載 → 瀏覽器顯示 404 錯誤頁面
- 使用者體驗不佳

### 之後
- 點擊下載 → 顯示美觀的提示視窗
- 明確告知這是機密文件
- 引導使用者聯繫管理員

## 視覺設計

```
┌─────────────────────────────────┐
│ ⚠️ 機密文件                  ✕ │
├─────────────────────────────────┤
│                                 │
│            🔒                   │
│                                 │
│      此為機密文件               │
│                                 │
│  此文件目前無法下載，如需存取   │
│  權限，請聯繫網站管理員。       │
│                                 │
├─────────────────────────────────┤
│        [ ✓ 我知道了 ]           │
└─────────────────────────────────┘
```

## 測試方式

1. **測試 404 URL 的文件**
   - 例如：`https://pub-e914f2115ec14dd98843404fadb92a24.r2.dev/不存在的檔案.pdf`
   - 嘗試下載該文件
   - 驗證端點會檢測到 404
   - 應該顯示機密文件提示，而不是開啟 404 頁面

2. **測試無效 URL 的文件**
   - 在資料庫中找到 `file_url` 為空或 `#` 的文件
   - 嘗試下載該文件
   - 應該顯示機密文件提示

3. **測試不存在的文件**
   - 嘗試下載一個不存在的文件 ID
   - 應該顯示機密文件提示

4. **測試正常文件**
   - 下載一個有效的文件
   - 應該正常開啟下載

## API 端點

### 驗證文件 (新增)
```
GET /api/v1/documents/:id/validate
```

**成功回應**
```json
{
  "success": true,
  "data": {
    "isValid": true
  }
}
```

**檔案無效回應**
```json
{
  "success": true,
  "data": {
    "isValid": false,
    "reason": "FILE_NOT_ACCESSIBLE",
    "statusCode": 404
  }
}
```

### 下載文件 (既有)
```
GET /api/v1/documents/:id/download
```

## 相關檔案

- `src/views/DocumentsView.vue` - 前端文件頁面
- `src/api/documents/downloads.ts` - 後端下載路由
- `src/components/common/DocumentCard.vue` - 文件卡片元件

## 未來改進

1. 可以添加「聯繫管理員」按鈕，直接開啟郵件或聯繫表單
2. 可以記錄使用者嘗試訪問機密文件的日誌
3. 可以為不同類型的錯誤顯示不同的提示訊息

---

最後更新：2025-11-07
