<template>
  <div class="learning-progress-view">
    <section class="section">
      <div class="container">
        <!-- Header -->
        <div class="mb-6">
          <h1 class="title is-2">æˆ‘çš„å­¸ç¿’é€²åº¦</h1>
          <p class="subtitle">è¿½è¹¤æ‚¨çš„èª²ç¨‹å­¸ç¿’ç‹€æ³</p>
        </div>

        <!-- Loading State -->
        <div v-if="loading" class="has-text-centered py-6">
          <button class="button is-loading is-large is-white" disabled>è¼‰å…¥ä¸­...</button>
        </div>

        <!-- Error State -->
        <div v-else-if="error" class="notification is-danger">
          <button class="delete" @click="error = null"></button>
          {{ error }}
        </div>

        <!-- Empty State -->
        <div v-else-if="enrollments.length === 0" class="notification is-info">
          <p class="has-text-centered">
            <i class="fas fa-info-circle"></i>
            æ‚¨å°šæœªè¨»å†Šä»»ä½•èª²ç¨‹
          </p>
          <div class="has-text-centered mt-4">
            <router-link to="/courses" class="button is-primary">
              <span class="icon">
                <i class="fas fa-search"></i>
              </span>
              <span>ç€è¦½èª²ç¨‹</span>
            </router-link>
          </div>
        </div>

        <!-- Enrollments List -->
        <div v-else>
          <!-- Statistics Cards -->
          <div class="columns mb-5">
            <div class="column">
              <div class="box has-text-centered">
                <p class="heading">ç¸½è¨»å†Šèª²ç¨‹</p>
                <p class="title is-3">{{ enrollments.length }}</p>
              </div>
            </div>
            <div class="column">
              <div class="box has-text-centered">
                <p class="heading">é€²è¡Œä¸­</p>
                <p class="title is-3 has-text-info">{{ inProgressCount }}</p>
              </div>
            </div>
            <div class="column">
              <div class="box has-text-centered">
                <p class="heading">å·²å®Œæˆ</p>
                <p class="title is-3 has-text-success">{{ completedCount }}</p>
              </div>
            </div>
            <div class="column">
              <div class="box has-text-centered">
                <p class="heading">å¹³å‡é€²åº¦</p>
                <p class="title is-3 has-text-primary">{{ averageProgress }}%</p>
              </div>
            </div>
          </div>

          <!-- Filter Tabs -->
          <div class="tabs is-boxed mb-4">
            <ul>
              <li :class="{ 'is-active': activeTab === 'all' }">
                <a @click="activeTab = 'all'">
                  <span class="icon is-small"><i class="fas fa-list"></i></span>
                  <span>å…¨éƒ¨èª²ç¨‹</span>
                </a>
              </li>
              <li :class="{ 'is-active': activeTab === 'in_progress' }">
                <a @click="activeTab = 'in_progress'">
                  <span class="icon is-small"><i class="fas fa-spinner"></i></span>
                  <span>é€²è¡Œä¸­</span>
                </a>
              </li>
              <li :class="{ 'is-active': activeTab === 'completed' }">
                <a @click="activeTab = 'completed'">
                  <span class="icon is-small"><i class="fas fa-check"></i></span>
                  <span>å·²å®Œæˆ</span>
                </a>
              </li>
            </ul>
          </div>

          <!-- Enrollment Cards -->
          <div class="columns is-multiline">
            <div
              v-for="enrollment in filteredEnrollments"
              :key="enrollment.id"
              class="column is-12"
            >
              <div class="box">
                <div class="columns is-vcentered">
                  <div class="column is-8">
                    <div class="level is-mobile mb-3">
                      <div class="level-left">
                        <div class="level-item">
                          <span class="tag" :class="getCourseTypeClass(enrollment.courseType)">
                            {{ getCourseTypeLabel(enrollment.courseType) }}
                          </span>
                        </div>
                        <div class="level-item">
                          <span class="tag" :class="getStatusClass(enrollment.status)">
                            {{ getStatusLabel(enrollment.status) }}
                          </span>
                        </div>
                      </div>
                    </div>

                    <h3 class="title is-4">{{ enrollment.courseTitle }}</h3>
                    <p class="subtitle is-6 has-text-grey">{{ enrollment.courseDescription }}</p>

                    <div class="mb-3">
                      <ProgressBar
                        :percentage="enrollment.progressPercentage"
                        :label="'å­¸ç¿’é€²åº¦'"
                        :color="getProgressColor(enrollment.progressPercentage)"
                      />
                    </div>

                    <div class="level is-mobile">
                      <div class="level-left">
                        <div class="level-item">
                          <span class="icon-text">
                            <span class="icon has-text-info">
                              <i class="fas fa-calendar"></i>
                            </span>
                            <span class="is-size-7">
                              è¨»å†Šæ—¥æœŸï¼š{{ formatDate(enrollment.enrollmentDate) }}
                            </span>
                          </span>
                        </div>
                        <div v-if="enrollment.completionDate" class="level-item">
                          <span class="icon-text">
                            <span class="icon has-text-success">
                              <i class="fas fa-check-circle"></i>
                            </span>
                            <span class="is-size-7">
                              å®Œæˆæ—¥æœŸï¼š{{ formatDate(enrollment.completionDate) }}
                            </span>
                          </span>
                        </div>
                      </div>
                    </div>

                    <div v-if="enrollment.finalScore !== null && enrollment.finalScore !== undefined" class="mt-3">
                      <span class="icon-text">
                        <span class="icon has-text-warning">
                          <i class="fas fa-star"></i>
                        </span>
                        <span class="has-text-weight-semibold">
                          æœ€çµ‚æˆç¸¾ï¼š{{ enrollment.finalScore }} åˆ†
                        </span>
                      </span>
                    </div>
                  </div>

                  <div class="column is-4 has-text-right">
                    <div class="buttons is-right">
                      <router-link
                        :to="'/courses/' + enrollment.courseId"
                        class="button is-info is-light"
                      >
                        <span class="icon">
                          <i class="fas fa-info-circle"></i>
                        </span>
                        <span>èª²ç¨‹è©³æƒ…</span>
                      </router-link>

                      <button
                        v-if="enrollment.status !== 'completed'"
                        class="button is-primary"
                        @click="openQuiz(enrollment)"
                      >
                        <span class="icon">
                          <i class="fas fa-pencil-alt"></i>
                        </span>
                        <span>é€²è¡Œæ¸¬é©—</span>
                      </button>

                      <button
                        v-if="enrollment.status === 'completed'"
                        class="button is-success"
                        @click="downloadCertificate(enrollment)"
                      >
                        <span class="icon">
                          <i class="fas fa-certificate"></i>
                        </span>
                        <span>ä¸‹è¼‰è­‰æ›¸</span>
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Quiz Modal -->
    <div class="modal" :class="{ 'is-active': showQuizModal }">
      <div class="modal-background" @click="closeQuiz"></div>
      <div class="modal-card">
        <header class="modal-card-head">
          <p class="modal-card-title">èª²ç¨‹æ¸¬é©—</p>
          <button class="delete" aria-label="close" @click="closeQuiz"></button>
        </header>
        <section class="modal-card-body">
          <div v-if="currentEnrollment">
            <h4 class="title is-4 mb-4">{{ currentEnrollment.courseTitle }}</h4>

            <div class="notification is-info is-light mb-4">
              <p><strong>æ¸¬é©—èªªæ˜ï¼š</strong></p>
              <ul>
                <li>æœ¬æ¸¬é©—å…± 10 é¡Œé¸æ“‡é¡Œ</li>
                <li>åŠæ ¼åˆ†æ•¸ç‚º 80 åˆ†</li>
                <li>å®Œæˆæ¸¬é©—å¾Œå°‡æ›´æ–°å­¸ç¿’é€²åº¦</li>
              </ul>
            </div>

            <div class="field">
              <label class="label">æ¨¡æ“¬æ¸¬é©—åˆ†æ•¸ï¼ˆ0-100ï¼‰</label>
              <div class="control">
                <input
                  v-model.number="quizScore"
                  class="input"
                  type="number"
                  min="0"
                  max="100"
                  placeholder="è¼¸å…¥æ¸¬é©—åˆ†æ•¸"
                />
              </div>
              <p class="help">å¯¦éš›ç³»çµ±ä¸­å°‡é¡¯ç¤ºçœŸå¯¦æ¸¬é©—é¡Œç›®</p>
            </div>
          </div>
        </section>
        <footer class="modal-card-foot">
          <button
            class="button is-primary"
            :class="{ 'is-loading': submittingQuiz }"
            :disabled="submittingQuiz || quizScore === null"
            @click="submitQuiz"
          >
            æäº¤æ¸¬é©—
          </button>
          <button class="button" @click="closeQuiz">å–æ¶ˆ</button>
        </footer>
      </div>
    </div>
  </div>
</template>

<script setup lang="ts">
import { ref, computed, onMounted } from 'vue'
import { useRouter } from 'vue-router'
import ProgressBar from '@/components/common/ProgressBar.vue'
import courseService from '@/services/course-service'
import type { CourseEnrollment } from '@/types'

const router = useRouter()

// State
const enrollments = ref<CourseEnrollment[]>([])
const loading = ref(false)
const error = ref<string | null>(null)
const activeTab = ref<'all' | 'in_progress' | 'completed'>('all')
const showQuizModal = ref(false)
const currentEnrollment = ref<CourseEnrollment | null>(null)
const quizScore = ref<number | null>(null)
const submittingQuiz = ref(false)

// Computed
const filteredEnrollments = computed(() => {
  if (activeTab.value === 'all') {
    return enrollments.value
  }
  return enrollments.value.filter(e => {
    if (activeTab.value === 'in_progress') {
      return e.status === 'enrolled' || e.status === 'in_progress'
    }
    return e.status === 'completed'
  })
})

const inProgressCount = computed(() => {
  return enrollments.value.filter(e => e.status === 'enrolled' || e.status === 'in_progress').length
})

const completedCount = computed(() => {
  return enrollments.value.filter(e => e.status === 'completed').length
})

const averageProgress = computed(() => {
  if (enrollments.value.length === 0) return 0
  const total = enrollments.value.reduce((sum, e) => sum + e.progressPercentage, 0)
  return Math.round(total / enrollments.value.length)
})

// Methods
const loadEnrollments = async () => {
  loading.value = true
  error.value = null

  try {
    enrollments.value = await courseService.getUserEnrollments()
  } catch (err: any) {
    error.value = err.response?.data?.error?.message || 'è¼‰å…¥å­¸ç¿’é€²åº¦å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦'
    console.error('Error loading enrollments:', err)
  } finally {
    loading.value = false
  }
}

const getCourseTypeClass = (courseType?: string) => {
  switch (courseType) {
    case 'basic':
      return 'is-info'
    case 'advanced':
      return 'is-warning'
    case 'internship':
      return 'is-success'
    default:
      return 'is-light'
  }
}

const getCourseTypeLabel = (courseType?: string) => {
  switch (courseType) {
    case 'basic':
      return 'åŸºç¤èª²ç¨‹'
    case 'advanced':
      return 'é€²éšèª²ç¨‹'
    case 'internship':
      return 'å¯¦ç¿’èª²ç¨‹'
    default:
      return 'èª²ç¨‹'
  }
}

const getStatusClass = (status: string) => {
  switch (status) {
    case 'completed':
      return 'is-success'
    case 'in_progress':
      return 'is-info'
    case 'enrolled':
      return 'is-warning'
    case 'dropped':
      return 'is-danger'
    default:
      return 'is-light'
  }
}

const getStatusLabel = (status: string) => {
  switch (status) {
    case 'completed':
      return 'å·²å®Œæˆ'
    case 'in_progress':
      return 'é€²è¡Œä¸­'
    case 'enrolled':
      return 'å·²è¨»å†Š'
    case 'dropped':
      return 'å·²é€€å‡º'
    default:
      return 'æœªçŸ¥'
  }
}

const getProgressColor = (percentage: number): 'primary' | 'info' | 'success' | 'warning' => {
  if (percentage >= 100) return 'success'
  if (percentage >= 75) return 'info'
  if (percentage >= 50) return 'warning'
  return 'primary'
}

const formatDate = (dateString: string) => {
  const date = new Date(dateString)
  return date.toLocaleDateString('zh-TW', {
    year: 'numeric',
    month: '2-digit',
    day: '2-digit'
  })
}

const openQuiz = (enrollment: CourseEnrollment) => {
  currentEnrollment.value = enrollment
  quizScore.value = null
  showQuizModal.value = true
}

const closeQuiz = () => {
  showQuizModal.value = false
  currentEnrollment.value = null
  quizScore.value = null
}

const submitQuiz = async () => {
  if (!currentEnrollment.value || quizScore.value === null) return

  submittingQuiz.value = true

  try {
    // Calculate new progress based on score
    const newProgress = quizScore.value >= 80 ? 100 : Math.min(currentEnrollment.value.progressPercentage + 20, 90)
    const newStatus = quizScore.value >= 80 ? 'completed' : 'in_progress'

    await courseService.updateCourseProgress(
      currentEnrollment.value.courseId,
      newProgress,
      newStatus
    )

    // Reload enrollments
    await loadEnrollments()

    // Show success message
    if (quizScore.value >= 80) {
      alert('æ­å–œæ‚¨é€šéæ¸¬é©—ï¼èª²ç¨‹å·²å®Œæˆã€‚')
    } else {
      alert('æ¸¬é©—æœªé€šéï¼Œè«‹ç¹¼çºŒå­¸ç¿’å¾Œå†æ¬¡å˜—è©¦ã€‚')
    }

    closeQuiz()
  } catch (err: any) {
    const errorMessage = err.response?.data?.error?.message || 'æäº¤æ¸¬é©—å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦'
    alert(errorMessage)
    console.error('Error submitting quiz:', err)
  } finally {
    submittingQuiz.value = false
  }
}

const downloadCertificate = async (enrollment: CourseEnrollment) => {
  try {
    // Generate certificate data
    const certificateData = {
      courseName: enrollment.courseTitle,
      completionDate: enrollment.completionDate,
      finalScore: enrollment.finalScore,
      courseType: getCourseTypeLabel(enrollment.courseType)
    }

    // Create a simple HTML certificate
    const certificateHTML = `
<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>èª²ç¨‹å®Œæˆè­‰æ›¸</title>
  <style>
    body {
      font-family: 'Microsoft JhengHei', Arial, sans-serif;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      margin: 0;
      background: #f5f5f5;
    }
    .certificate {
      width: 800px;
      padding: 60px;
      background: white;
      border: 10px solid #3273dc;
      box-shadow: 0 0 20px rgba(0,0,0,0.1);
      text-align: center;
    }
    .certificate h1 {
      color: #3273dc;
      font-size: 48px;
      margin-bottom: 20px;
    }
    .certificate h2 {
      color: #363636;
      font-size: 32px;
      margin: 30px 0;
    }
    .certificate p {
      font-size: 18px;
      line-height: 1.8;
      color: #4a4a4a;
      margin: 15px 0;
    }
    .certificate .course-name {
      font-size: 28px;
      font-weight: bold;
      color: #3273dc;
      margin: 30px 0;
    }
    .certificate .score {
      font-size: 24px;
      color: #48c774;
      font-weight: bold;
      margin: 20px 0;
    }
    .certificate .footer {
      margin-top: 50px;
      padding-top: 30px;
      border-top: 2px solid #dbdbdb;
      font-size: 16px;
      color: #7a7a7a;
    }
    @media print {
      body { background: white; }
      .certificate { box-shadow: none; }
    }
  </style>
</head>
<body>
  <div class="certificate">
    <h1>ğŸ“ èª²ç¨‹å®Œæˆè­‰æ›¸</h1>
    <h2>Certificate of Completion</h2>
    
    <p>èŒ²è­‰æ˜</p>
    <p class="course-name">${certificateData.courseName}</p>
    <p>èª²ç¨‹é¡å‹ï¼š${certificateData.courseType}</p>
    
    <p>å·²æ–¼ ${formatDate(certificateData.completionDate || '')} å®Œæˆèª²ç¨‹</p>
    
    ${certificateData.finalScore ? `<p class="score">æœ€çµ‚æˆç¸¾ï¼š${certificateData.finalScore} åˆ†</p>` : ''}
    
    <div class="footer">
      <p><strong>è—¥åŠ©Nextå­¸é™¢</strong></p>
      <p>Pharmacy Assistant Academy</p>
      <p>ç™¼è­‰æ—¥æœŸï¼š${new Date().toLocaleDateString('zh-TW')}</p>
    </div>
  </div>
  
  <script>
    // Auto print on load
    window.onload = function() {
      setTimeout(function() {
        window.print();
      }, 500);
    };
  <\/script>
<\/body>
<\/html>
    `

    // Open certificate in new window
    const printWindow = window.open('', '_blank')
    if (printWindow) {
      printWindow.document.write(certificateHTML)
      printWindow.document.close()
    } else {
      alert('è«‹å…è¨±å½ˆå‡ºè¦–çª—ä»¥ä¸‹è¼‰è­‰æ›¸')
    }
  } catch (err) {
    console.error('Error generating certificate:', err)
    alert('ç”Ÿæˆè­‰æ›¸å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦')
  }
}

// Lifecycle
onMounted(() => {
  loadEnrollments()
})
</script>

<style scoped>
.learning-progress-view {
  min-height: calc(100vh - 200px);
}

.tabs {
  margin-bottom: 1.5rem;
}
</style>
