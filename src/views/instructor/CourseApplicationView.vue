<template>
  <div class="container is-max-desktop">
    <div class="box">
      <h1 class="title is-4 has-text-centered">
        <span class="icon-text">
          <span class="icon">
            <span>ğŸ‘¨â€ğŸ«</span>
          </span>
          <span>ç”³è«‹é–‹èª²</span>
        </span>
      </h1>

      <form @submit.prevent="submitApplication" class="mt-5">
        <!-- èª²ç¨‹åŸºæœ¬è³‡è¨Š -->
        <div class="field">
          <label class="label">èª²ç¨‹åç¨± *</label>
          <div class="control">
            <input
              v-model="form.courseName"
              class="input"
              type="text"
              placeholder="è«‹è¼¸å…¥èª²ç¨‹åç¨±"
              required
            />
          </div>
          <p class="help">è«‹æä¾›æ¸…æ¥šæ˜ç¢ºçš„èª²ç¨‹åç¨±</p>
        </div>

        <div class="field">
          <label class="label">èª²ç¨‹ç°¡ä»‹ *</label>
          <div class="control">
            <textarea
              v-model="form.description"
              class="textarea"
              placeholder="è«‹è©³ç´°æè¿°èª²ç¨‹å…§å®¹ã€å­¸ç¿’ç›®æ¨™ç­‰"
              rows="4"
              required
            ></textarea>
          </div>
          <p class="help">è«‹è©³ç´°èªªæ˜èª²ç¨‹å…§å®¹å’Œå­¸ç¿’ç›®æ¨™</p>
        </div>

        <!-- èª²ç¨‹åˆ†é¡å’Œç›®æ¨™æ—ç¾¤ -->
        <div class="columns">
          <div class="column">
            <div class="field">
              <label class="label">èª²ç¨‹åˆ†é¡ *</label>
              <div class="control">
                <div class="select is-fullwidth">
                  <select v-model="form.category" required>
                    <option value="">è«‹é¸æ“‡èª²ç¨‹åˆ†é¡</option>
                    <option value="pharmacy_basics">è—¥å±€åŸºç¤</option>
                    <option value="medication_knowledge">è—¥ç‰©çŸ¥è­˜</option>
                    <option value="customer_service">å®¢æˆ¶æœå‹™</option>
                    <option value="business_management">ç¶“ç‡Ÿç®¡ç†</option>
                    <option value="legal_compliance">æ³•è¦éµå¾ª</option>
                    <option value="technology">ç§‘æŠ€æ‡‰ç”¨</option>
                    <option value="marketing">è¡ŒéŠ·æ¨å»£</option>
                    <option value="other">å…¶ä»–</option>
                  </select>
                </div>
              </div>
            </div>
          </div>

          <div class="column">
            <div class="field">
              <label class="label">ç›®æ¨™æ—ç¾¤ *</label>
              <div class="control">
                <div class="select is-fullwidth">
                  <select v-model="form.targetAudience" required>
                    <option value="">è«‹é¸æ“‡ç›®æ¨™æ—ç¾¤</option>
                    <option value="pharmacy_assistant">æº–è—¥åŠ©</option>
                    <option value="senior_assistant">é«˜ç´šè—¥åŠ©</option>
                    <option value="pharmacy_owner">è—¥å±€è€é—†</option>
                    <option value="entrepreneur">æƒ³é–‹åº—</option>
                    <option value="all">æ‰€æœ‰æ—ç¾¤</option>
                  </select>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- èª²ç¨‹æ™‚æ•¸å’Œè²»ç”¨ -->
        <div class="columns">
          <div class="column">
            <div class="field">
              <label class="label">èª²ç¨‹æ™‚æ•¸ *</label>
              <div class="control">
                <input
                  v-model.number="form.duration"
                  class="input"
                  type="number"
                  placeholder="å°æ™‚"
                  min="1"
                  max="100"
                  required
                />
              </div>
              <p class="help">è«‹è¼¸å…¥èª²ç¨‹ç¸½æ™‚æ•¸ï¼ˆå°æ™‚ï¼‰</p>
            </div>
          </div>

          <div class="column">
            <div class="field">
              <label class="label">èª²ç¨‹è²»ç”¨ *</label>
              <div class="control">
                <div class="field has-addons">
                  <div class="control">
                    <input
                      v-model.number="form.price"
                      class="input"
                      type="number"
                      placeholder="0"
                      min="0"
                      step="100"
                      required
                    />
                  </div>
                  <div class="control">
                    <span class="button is-static">å…ƒ</span>
                  </div>
                </div>
              </div>
              <p class="help">è«‹è¼¸å…¥èª²ç¨‹è²»ç”¨ï¼ˆæ–°å°å¹£ï¼‰</p>
            </div>
          </div>
        </div>

        <!-- æˆèª²æ–¹å¼ -->
        <div class="field">
          <label class="label">æˆèª²æ–¹å¼ *</label>
          <div class="control">
            <div class="field is-grouped is-grouped-multiline">
              <div class="control">
                <label class="checkbox">
                  <input v-model="form.deliveryMethods" type="checkbox" value="online" />
                  ç·šä¸Šæˆèª²
                </label>
              </div>
              <div class="control">
                <label class="checkbox">
                  <input v-model="form.deliveryMethods" type="checkbox" value="offline" />
                  å¯¦é«”æˆèª²
                </label>
              </div>
              <div class="control">
                <label class="checkbox">
                  <input v-model="form.deliveryMethods" type="checkbox" value="hybrid" />
                  æ··åˆæˆèª²
                </label>
              </div>
            </div>
          </div>
          <p class="help">å¯é¸æ“‡å¤šç¨®æˆèª²æ–¹å¼</p>
        </div>

        <!-- èª²ç¨‹å¤§ç¶± -->
        <div class="field">
          <label class="label">èª²ç¨‹å¤§ç¶± *</label>
          <div class="control">
            <textarea
              v-model="form.syllabus"
              class="textarea"
              placeholder="è«‹è©³ç´°åˆ—å‡ºèª²ç¨‹ç« ç¯€å’Œå…§å®¹å®‰æ’"
              rows="6"
              required
            ></textarea>
          </div>
          <p class="help">è«‹è©³ç´°åˆ—å‡ºèª²ç¨‹ç« ç¯€å’Œå…§å®¹å®‰æ’</p>
        </div>

        <!-- è¬›å¸«è³‡æ­· -->
        <div class="field">
          <label class="label">ç›¸é—œæ•™å­¸ç¶“é©— *</label>
          <div class="control">
            <textarea
              v-model="form.teachingExperience"
              class="textarea"
              placeholder="è«‹æè¿°æ‚¨çš„ç›¸é—œæ•™å­¸ç¶“é©—å’Œå°ˆæ¥­èƒŒæ™¯"
              rows="3"
              required
            ></textarea>
          </div>
          <p class="help">è«‹æè¿°æ‚¨çš„ç›¸é—œæ•™å­¸ç¶“é©—å’Œå°ˆæ¥­èƒŒæ™¯</p>
        </div>

        <!-- èª²ç¨‹ææ–™ -->
        <div class="field">
          <label class="label">èª²ç¨‹ææ–™</label>
          <div class="control">
            <textarea
              v-model="form.materials"
              class="textarea"
              placeholder="è«‹åˆ—å‡ºèª²ç¨‹æ‰€éœ€ææ–™ï¼ˆè¬›ç¾©ã€æ•™æã€å·¥å…·ç­‰ï¼‰"
              rows="3"
            ></textarea>
          </div>
          <p class="help">è«‹åˆ—å‡ºèª²ç¨‹æ‰€éœ€ææ–™ï¼ˆè¬›ç¾©ã€æ•™æã€å·¥å…·ç­‰ï¼‰</p>
        </div>

        <!-- ç‰¹æ®Šéœ€æ±‚ -->
        <div class="field">
          <label class="label">ç‰¹æ®Šéœ€æ±‚æˆ–å‚™è¨»</label>
          <div class="control">
            <textarea
              v-model="form.specialRequirements"
              class="textarea"
              placeholder="å¦‚æœ‰ç‰¹æ®Šéœ€æ±‚æˆ–å‚™è¨»è«‹åœ¨æ­¤èªªæ˜"
              rows="2"
            ></textarea>
          </div>
        </div>

        <!-- æäº¤æŒ‰éˆ• -->
        <div class="field is-grouped is-grouped-centered">
          <div class="control">
            <button
              type="submit"
              class="button is-primary is-large"
              :class="{ 'is-loading': isSubmitting }"
              :disabled="isSubmitting"
            >
              <span class="icon">
                <i class="fas fa-paper-plane"></i>
              </span>
              <span>æäº¤ç”³è«‹</span>
            </button>
          </div>
          <div class="control">
            <button type="button" class="button is-light is-large" @click="resetForm">
              <span class="icon">
                <i class="fas fa-undo"></i>
              </span>
              <span>é‡ç½®è¡¨å–®</span>
            </button>
          </div>
        </div>
      </form>

      <!-- æˆåŠŸè¨Šæ¯ -->
      <div v-if="showSuccessMessage" class="notification is-success mt-4">
        <button class="delete" @click="showSuccessMessage = false"></button>
        <strong>ç”³è«‹æäº¤æˆåŠŸï¼</strong>
        <p>æ‚¨çš„é–‹èª²ç”³è«‹å·²æäº¤ï¼Œæˆ‘å€‘æœƒç›¡å¿«å¯©æ ¸ä¸¦èˆ‡æ‚¨è¯ç¹«ã€‚</p>
      </div>

      <!-- éŒ¯èª¤è¨Šæ¯ -->
      <div v-if="errorMessage" class="notification is-danger mt-4">
        <button class="delete" @click="errorMessage = ''"></button>
        <strong>æäº¤å¤±æ•—ï¼</strong>
        <p>{{ errorMessage }}</p>
      </div>
    </div>
  </div>
</template>

<script setup lang="ts">
import { ref, reactive } from 'vue'
import { useRouter } from 'vue-router'
import { api } from '@/services/api'

const router = useRouter()

// è¡¨å–®æ•¸æ“š
const form = reactive({
  courseName: '',
  description: '',
  category: '',
  targetAudience: '',
  duration: null as number | null,
  price: null as number | null,
  deliveryMethods: [] as string[],
  syllabus: '',
  teachingExperience: '',
  materials: '',
  specialRequirements: ''
})

// ç‹€æ…‹
const isSubmitting = ref(false)
const showSuccessMessage = ref(false)
const errorMessage = ref('')

// æäº¤ç”³è«‹
async function submitApplication() {
  if (isSubmitting.value) return

  // é©—è­‰è¡¨å–®
  if (!validateForm()) return

  isSubmitting.value = true
  errorMessage.value = ''

  try {
    const response = await api.post('/course-applications', {
      course_name: form.courseName,
      description: form.description,
      category: form.category,
      target_audience: form.targetAudience,
      duration: form.duration,
      price: form.price,
      delivery_methods: form.deliveryMethods.join(','),
      syllabus: form.syllabus,
      teaching_experience: form.teachingExperience,
      materials: form.materials,
      special_requirements: form.specialRequirements
    })

    if (response.data?.success) {
      showSuccessMessage.value = true
      resetForm()

      // 3ç§’å¾Œè·³è½‰åˆ°è¬›å¸«å„€è¡¨æ¿
      setTimeout(() => {
        router.push('/instructor/dashboard')
      }, 3000)
    } else {
      errorMessage.value = response.data?.message || 'æäº¤å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦'
    }
  } catch (error: any) {
    console.error('æäº¤é–‹èª²ç”³è«‹å¤±æ•—:', error)
    errorMessage.value = error.response?.data?.message || 'æäº¤å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦'
  } finally {
    isSubmitting.value = false
  }
}

// é©—è­‰è¡¨å–®
function validateForm(): boolean {
  if (!form.courseName.trim()) {
    errorMessage.value = 'è«‹è¼¸å…¥èª²ç¨‹åç¨±'
    return false
  }

  if (!form.description.trim()) {
    errorMessage.value = 'è«‹è¼¸å…¥èª²ç¨‹ç°¡ä»‹'
    return false
  }

  if (!form.category) {
    errorMessage.value = 'è«‹é¸æ“‡èª²ç¨‹åˆ†é¡'
    return false
  }

  if (!form.targetAudience) {
    errorMessage.value = 'è«‹é¸æ“‡ç›®æ¨™æ—ç¾¤'
    return false
  }

  if (!form.duration || form.duration <= 0) {
    errorMessage.value = 'è«‹è¼¸å…¥æœ‰æ•ˆçš„èª²ç¨‹æ™‚æ•¸'
    return false
  }

  if (form.price === null || form.price < 0) {
    errorMessage.value = 'è«‹è¼¸å…¥æœ‰æ•ˆçš„èª²ç¨‹è²»ç”¨'
    return false
  }

  if (form.deliveryMethods.length === 0) {
    errorMessage.value = 'è«‹è‡³å°‘é¸æ“‡ä¸€ç¨®æˆèª²æ–¹å¼'
    return false
  }

  if (!form.syllabus.trim()) {
    errorMessage.value = 'è«‹è¼¸å…¥èª²ç¨‹å¤§ç¶±'
    return false
  }

  if (!form.teachingExperience.trim()) {
    errorMessage.value = 'è«‹æè¿°æ‚¨çš„æ•™å­¸ç¶“é©—'
    return false
  }

  return true
}

// é‡ç½®è¡¨å–®
function resetForm() {
  Object.assign(form, {
    courseName: '',
    description: '',
    category: '',
    targetAudience: '',
    duration: null,
    price: null,
    deliveryMethods: [],
    syllabus: '',
    teachingExperience: '',
    materials: '',
    specialRequirements: ''
  })
  errorMessage.value = ''
  showSuccessMessage.value = false
}
</script>

<style scoped>
.container {
  padding: 2rem 1rem;
}

.box {
  max-width: 800px;
  margin: 0 auto;
}

.field {
  margin-bottom: 1.5rem;
}

.checkbox {
  margin-right: 1rem;
}

.notification {
  margin-top: 1rem;
}

.button.is-large {
  padding: 1rem 2rem;
}

@media (max-width: 768px) {
  .columns {
    flex-direction: column;
  }

  .field.is-grouped-multiline .control {
    margin-bottom: 0.5rem;
  }
}
</style>
