<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>文件上傳測試</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.4/css/bulma.min.css">
    <style>
        body {
            padding: 2rem;
        }

        .upload-area {
            border: 2px dashed #dbdbdb;
            border-radius: 6px;
            padding: 3rem;
            text-align: center;
            background-color: #fafafa;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .upload-area:hover {
            border-color: #3273dc;
            background-color: #f5f5f5;
        }

        .upload-area.is-dragover {
            border-color: #3273dc;
            background-color: #eff5fb;
        }

        .log-area {
            background-color: #f5f5f5;
            padding: 1rem;
            border-radius: 6px;
            max-height: 400px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 0.875rem;
        }

        .log-entry {
            margin-bottom: 0.5rem;
            padding: 0.5rem;
            border-radius: 4px;
        }

        .log-entry.success {
            background-color: #d4edda;
            color: #155724;
        }

        .log-entry.error {
            background-color: #f8d7da;
            color: #721c24;
        }

        .log-entry.info {
            background-color: #d1ecf1;
            color: #0c5460;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1 class="title">文件上傳功能測試</h1>
        <p class="subtitle">測試文件上傳 API 端點</p>

        <!-- 登入區域 -->
        <div class="box">
            <h2 class="title is-4">1. 管理員登入</h2>
            <div class="field">
                <label class="label">Email</label>
                <div class="control">
                    <input class="input" type="email" id="email" value="admin@ttqs.com">
                </div>
            </div>
            <div class="field">
                <label class="label">密碼</label>
                <div class="control">
                    <input class="input" type="password" id="password" value="admin123">
                </div>
            </div>
            <div class="field">
                <div class="control">
                    <button class="button is-primary" onclick="login()">登入</button>
                </div>
            </div>
            <div id="token-display" class="notification is-info is-light" style="display: none;">
                <p><strong>Token:</strong> <span id="token-value"></span></p>
            </div>
        </div>

        <!-- 文件上傳區域 -->
        <div class="box">
            <h2 class="title is-4">2. 上傳文件</h2>
            <div class="upload-area" id="uploadArea">
                <p class="title is-5">拖曳文件到此處或點擊選擇</p>
                <input type="file" id="fileInput" style="display: none;">
                <button class="button is-primary mt-3" onclick="document.getElementById('fileInput').click()">
                    選擇文件
                </button>
            </div>
            <div id="file-info" class="notification is-info mt-3" style="display: none;">
                <p><strong>已選擇文件:</strong> <span id="file-name"></span></p>
                <p><strong>文件大小:</strong> <span id="file-size"></span></p>
                <p><strong>文件類型:</strong> <span id="file-type"></span></p>
            </div>
            <div class="field mt-3">
                <label class="label">文件分類</label>
                <div class="control">
                    <div class="select">
                        <select id="category">
                            <option value="general">一般文件</option>
                            <option value="course_materials">課程資料</option>
                            <option value="documents">文檔</option>
                            <option value="images">圖片</option>
                            <option value="videos">視頻</option>
                            <option value="ttqs">TTQS文件</option>
                        </select>
                    </div>
                </div>
            </div>
            <div class="field">
                <div class="control">
                    <button class="button is-success" onclick="uploadFile()" id="uploadBtn" disabled>
                        上傳文件
                    </button>
                </div>
            </div>
        </div>

        <!-- 文件列表 -->
        <div class="box">
            <h2 class="title is-4">3. 文件列表</h2>
            <button class="button is-info" onclick="fetchFiles()">
                刷新列表
            </button>
            <button class="button is-warning ml-2" onclick="syncR2Files()">
                同步 R2 文件
            </button>
            <div id="files-list" class="mt-3"></div>
        </div>

        <!-- 日誌區域 -->
        <div class="box">
            <h2 class="title is-4">操作日誌</h2>
            <button class="button is-small is-light" onclick="clearLog()">清除日誌</button>
            <div id="log" class="log-area mt-3"></div>
        </div>
    </div>

    <script>
        const API_BASE = 'https://a58800bf.pharmacy-assistant-academy.pages.dev/api/v1';
        let authToken = null;
        let selectedFile = null;

        // 日誌函數
        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logDiv.insertBefore(entry, logDiv.firstChild);
        }

        function clearLog() {
            document.getElementById('log').innerHTML = '';
        }

        // 登入
        async function login() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;

            log('正在登入...', 'info');

            try {
                const response = await fetch(`${API_BASE}/auth/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ email, password })
                });

                const data = await response.json();

                if (data.success) {
                    authToken = data.data.token;
                    document.getElementById('token-display').style.display = 'block';
                    document.getElementById('token-value').textContent = authToken.substring(0, 50) + '...';
                    log('登入成功！', 'success');
                } else {
                    log(`登入失敗: ${data.message}`, 'error');
                }
            } catch (error) {
                log(`登入錯誤: ${error.message}`, 'error');
            }
        }

        // 文件選擇
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');

        uploadArea.addEventListener('click', () => {
            fileInput.click();
        });

        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('is-dragover');
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('is-dragover');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('is-dragover');
            const file = e.dataTransfer.files[0];
            handleFileSelect(file);
        });

        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            handleFileSelect(file);
        });

        function handleFileSelect(file) {
            if (!file) return;

            selectedFile = file;
            document.getElementById('file-info').style.display = 'block';
            document.getElementById('file-name').textContent = file.name;
            document.getElementById('file-size').textContent = formatFileSize(file.size);
            document.getElementById('file-type').textContent = file.type;
            document.getElementById('uploadBtn').disabled = false;

            log(`已選擇文件: ${file.name}`, 'info');
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return Math.round((bytes / Math.pow(k, i)) * 100) / 100 + ' ' + sizes[i];
        }

        // 上傳文件
        async function uploadFile() {
            if (!authToken) {
                log('請先登入！', 'error');
                return;
            }

            if (!selectedFile) {
                log('請先選擇文件！', 'error');
                return;
            }

            const category = document.getElementById('category').value;
            const formData = new FormData();
            formData.append('file', selectedFile);
            formData.append('category', category);
            formData.append('description', `測試上傳 - ${new Date().toLocaleString()}`);

            log('正在上傳文件...', 'info');

            try {
                const response = await fetch(`${API_BASE}/upload`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: formData
                });

                const data = await response.json();

                if (data.success) {
                    log('文件上傳成功！', 'success');
                    log(`文件 URL: ${data.data.fileUrl}`, 'success');
                    selectedFile = null;
                    document.getElementById('file-info').style.display = 'none';
                    document.getElementById('uploadBtn').disabled = true;
                    fileInput.value = '';
                    fetchFiles();
                } else {
                    log(`上傳失敗: ${data.message}`, 'error');
                }
            } catch (error) {
                log(`上傳錯誤: ${error.message}`, 'error');
            }
        }

        // 獲取文件列表
        async function fetchFiles() {
            if (!authToken) {
                log('請先登入！', 'error');
                return;
            }

            log('正在獲取文件列表...', 'info');

            try {
                const response = await fetch(`${API_BASE}/upload?page=1&limit=10`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                const data = await response.json();

                if (data.success) {
                    const files = data.data.files || data.data;
                    log(`成功獲取 ${files.length} 個文件`, 'success');
                    displayFiles(files);
                } else {
                    log(`獲取文件列表失敗: ${data.message}`, 'error');
                }
            } catch (error) {
                log(`獲取文件列表錯誤: ${error.message}`, 'error');
            }
        }

        function displayFiles(files) {
            const listDiv = document.getElementById('files-list');
            if (files.length === 0) {
                listDiv.innerHTML = '<p class="has-text-grey">沒有文件</p>';
                return;
            }

            let html = '<table class="table is-fullwidth is-striped"><thead><tr><th>文件名</th><th>分類</th><th>大小</th><th>URL</th></tr></thead><tbody>';
            files.forEach(file => {
                html += `
                    <tr>
                        <td>${file.title}</td>
                        <td><span class="tag">${file.category || 'N/A'}</span></td>
                        <td>${formatFileSize(file.file_size || 0)}</td>
                        <td><a href="${file.file_url}" target="_blank" class="button is-small is-link">查看</a></td>
                    </tr>
                `;
            });
            html += '</tbody></table>';
            listDiv.innerHTML = html;
        }

        // 同步 R2 文件
        async function syncR2Files() {
            if (!authToken) {
                log('請先登入！', 'error');
                return;
            }

            log('正在同步 R2 文件...', 'info');

            try {
                const response = await fetch(`${API_BASE}/sync-files`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                const data = await response.json();

                if (data.success) {
                    log(`成功同步 ${data.data.synced} 個文件`, 'success');
                    fetchFiles();
                } else {
                    log(`同步失敗: ${data.message}`, 'error');
                }
            } catch (error) {
                log(`同步錯誤: ${error.message}`, 'error');
            }
        }

        // 頁面加載時的提示
        log('頁面已加載，請先登入管理員帳號', 'info');
    </script>
</body>

</html>